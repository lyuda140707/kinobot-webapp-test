<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RelaxTime Web App</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="https://example.com/my-favicon.ico">
  <link rel="stylesheet" href="style.css?v=50" />
  <link href="https://fonts.googleapis.com/css2?family=Russo+One&display=swap" rel="stylesheet">
  <style>

/* –†—ñ–∫ –ø—ñ–¥ –Ω–∞–∑–≤–æ—é */
.film-year{
  font-size:12px;
  color:#bbb;
  margin:2px 0 6px;
}
.year-badge{
  position: absolute;

  /* ‚ÜòÔ∏è —Å—Ç–∞–≤–∏–º–æ –≤–Ω–∏–∑ –ø—Ä–∞–≤–æ—Ä—É—á */
  bottom: 8px;
  right: 8px;
  top: auto;
  left: auto;

  padding: 4px 10px;
  font-size: 12px;
  border-radius: 10px;

  /* —Ç–µ–º–Ω–∏–π —Ñ–æ–Ω + —Å–∏–ª—å–Ω—ñ—à–µ —Å–≤—ñ—Ç—ñ–Ω–Ω—è —É –≤–∞—à–æ–º—É –±—ñ—Ä—é–∑–æ–≤–æ–º—É —Å—Ç–∏–ª—ñ */
  background: rgba(0,0,0,.45);
  color: #eafefe;
  border: 1px solid rgba(0,247,255,.65);
  box-shadow:
    0 0 10px rgba(0,247,255,.65),
    0 0 18px rgba(0,247,255,.35);

  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  font-variant-numeric: tabular-nums;
  pointer-events: none;
  transition: transform .15s ease, box-shadow .15s ease;
}

/* —Ç—Ä–æ—Ö–∏ –ø—ñ–¥—Å–∏–ª—é—î–º–æ —Å—è–π–≤–æ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ –Ω–∞ –∫–∞—Ä—Ç–∫—É */
.film-card:hover .year-badge{
  transform: translateY(-1px) scale(1.05);
  box-shadow:
    0 0 12px rgba(0,247,255,.85),
    0 0 24px rgba(0,247,255,.55);
}

.poster-wrap .year-badge{
  bottom:8px; right:8px; top:auto; left:auto;
}
    
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #111;
      color: #fff;
    }
    .section {
      display: none;
      padding: 20px;
    }
    .active {
      display: block;
    }
    .nav {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      display: flex;
      justify-content: space-around;
      padding: 10px 0 6px;
      border-top: 1px solid #333;
      z-index: 999;
      box-shadow: 0 -2px 10px rgba(0, 255, 255, 0.15);
    }
    .nav button {
      background: none;
      border: none;
      color: #aaa;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 10px;
      transition: all 0.2s ease-in-out;
      position: relative;
    }
    .nav button span {
      margin-top: 4px;
      font-size: 14px;
    }
    .nav button.active {
      color: #00f7ff;
      text-shadow: 0 0 6px #00f7ff;
      transform: scale(1.1);
    }
    .nav button.active::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 50%;
      transform: translateX(-50%);
      width: 36%;
      height: 3px;
      border-radius: 3px;
      background: #00f7ff;
      box-shadow: 0 0 8px #00f7ff;
    }
    
    .back-button {
      background: #444;
      color: #fff;
      padding: 8px 16px;
      margin-bottom: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
.loader {
  border: 4px solid #444;
  border-top: 4px solid #fff;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  display: inline-block;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}


    .skeleton {
  background-color: #333;
  border-radius: 8px;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}
    /* –î–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –ø–æ—è–≤–∏ –º–æ–¥–∞–ª–∫–∏ */
#confirm-modal {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

#confirm-modal.show {
  opacity: 1;
  pointer-events: auto;
}
@keyframes pulse-glow {
  0% {
    text-shadow: 0 0 6px #00f7ff;
    transform: scale(1);
  }
  50% {
    text-shadow: 0 0 15px #00f7ff;
    transform: scale(1.15);
  }
  100% {
    text-shadow: 0 0 6px #00f7ff;
    transform: scale(1);
  }
}
/* üíé –ú–∏–≥–æ—Ç—ñ–Ω–Ω—è –±—ñ—Ä—é–∑–æ–≤–æ–≥–æ —Ç–µ–∫—Å—Ç—É "–ë—É–¥—å-—è–∫–∞ —Å—É–º–∞ (–≤—ñ–¥ 20 –≥—Ä–Ω) ‚Äî PRO –¥–æ—Å—Ç—É–ø" */
@keyframes proGlow {
  0%, 100% {
    text-shadow: 0 0 8px #00f7ff, 0 0 16px rgba(0,247,255,.8);
    color: #00f7ff;
    transform: scale(1);
  }
  50% {
    text-shadow: 0 0 16px #00ffff, 0 0 28px rgba(0,247,255,1);
    color: #ffffff;
    transform: scale(1.05);
  }
}

.pro-amount-glow {
  font-size: 17px;
  font-weight: 800;
  color: #00f7ff;
  text-align: center;
  display: inline-block;
  margin-top: 12px;
  background: rgba(0,0,0,0.45);
  padding: 8px 14px;
  border-radius: 14px;
  animation: proGlow 1.5s ease-in-out infinite;
}

.pro-amount-glow span {
  color: #fff;
}

.pro-amount-glow strong {
  color: #00f7ff;
}

/* === –ù–û–í–ò–ô –°–¢–ò–õ–¨ –î–õ–Ø DONATE-POPUP === */
#donate-popup {
  display: none; /* —Ü—é –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å JS –∫–µ—Ä—É—î */
  position: fixed;
  bottom: 120px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, #ff7f50, #ff4500);
  border: 2px solid #fff;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  box-shadow:
    0 0 12px rgba(255,69,0,0.8),
    0 0 24px rgba(255,140,0,0.6);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  z-index: 9999;
}

#donate-popup:hover {
  transform: translateX(-50%) translateY(-4px);
  box-shadow:
    0 0 16px rgba(255,69,0,1),
    0 0 32px rgba(255,140,0,0.8);
}

/* –∫–Ω–æ–ø–∫–∞ ¬´–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏¬ª */
#donate-popup .btn-donate {
  display: inline-block;
  background-color: #ffd700;
  color: #000;
  padding: 12px 24px;
  font-weight: bold;
  text-decoration: none;
  border-radius: 8px;
  text-shadow: 0 0 6px rgba(255,215,0,0.8);
  box-shadow: 0 0 10px rgba(255,215,0,0.6);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

#donate-popup .btn-donate:hover {
  transform: scale(1.05);
  box-shadow:
    0 0 14px rgba(255,215,0,1),
    0 0 28px rgba(255,215,0,0.8);
}

/* —Ö—Ä–µ—Å—Ç–∏–∫ –∑–∞–∫—Ä–∏—Ç—Ç—è */
#donate-popup > button {
  position: absolute;
  top: 6px;
  right: 10px;
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  color: #fff;
  transition: transform 0.2s ease;
}

#donate-popup > button:hover {
  transform: scale(1.2);
}


.series-episodes-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  margin-top: 10px;
}

.series-episodes-grid .search-button {
  font-size: 11.5px;
  padding: 6px 10px;
  border-radius: 10px;
  white-space: normal;
  line-height: 1.1;
  text-align: center;
}
/* === Seasons UI === */
.seasons-row{
  display:flex; gap:8px; justify-content:center; flex-wrap:wrap;
  margin:8px 0 6px;
}
.season-btn{
  background:#222; border:1px solid #444; border-radius:14px;
  padding:6px 10px; font-weight:700; font-size:13px;
  color:#00f7ff; cursor:pointer;
  box-shadow:0 0 6px #00f7ff, 0 0 12px rgba(0,255,255,.35);
}
.season-btn.active{ background:#00f7ff; color:#000; }
.series-episodes-season{ display:none; margin-top:8px; }


.series-poster {
  width: 100px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
  margin-right: 10px;
  vertical-align: middle;
}
    
/* –¥–ª—è –≤—Å—ñ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ñ—ñ–ª—å–º—ñ–≤ */
#genre-results,
#searchResults,
#fav-list {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;        /* –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –∫–∞—Ä—Ç–∫–∞–º–∏ */
  padding: 10px;    /* –ø—Ä–∏ –ø–æ—Ç—Ä–µ–±—ñ –≤–∞—à—ñ –≤—ñ–¥—Å—Ç—É–ø–∏ */
}



.film-card {
  background: #1a1a1a;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 0 10px cyan;
  box-sizing: border-box;
  width: 100%;
  max-width: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
}





.film-img {
  width: 100%;
  max-width: 100%;
  height: 120px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 10px;
}


/* –û–±–≥–æ—Ä—Ç–∫–∞ –ø–æ—Å—Ç–µ—Ä–∞ + –±–µ–π–¥–∂ —Ä–æ–∫—É */
.poster-wrap{
  position: relative;
  width: 100%;
}




.film-content {
  text-align: center;
}

.search-button {
  background-color: #00d4ff;
  color: #000;
  border: none;
  border-radius: 20px;
  padding: 6px 14px;
  font-weight: bold;
  margin: 4px;
  cursor: pointer;
}

.favorite-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
}
.film-rating {
  font-weight: bold;
  color: #00ffff;
  font-size: 14px;
  margin: 6px 0;
  text-shadow: 0 0 5px rgba(0,255,255,0.3);
  background: rgba(0,255,255,0.1);
  padding: 4px 8px;
  border-radius: 8px;
  display: inline-block;
}

.film-buttons {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-top: 10px;
  flex-wrap: wrap;
}    

.film-actions {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin-top: 10px;
  flex-wrap: wrap;
}



/* –ù–ï–û–ù–û–í–ò–ô –°–í–Ü–¢–õ–Ø–ù–ò–ô –ï–§–ï–ö–¢ –î–õ–Ø IMDb */
.film-card .film-imdb {
  font-size: 12px;
  font-weight: bold;
  color: #00ffff;
  margin: 4px 0;
  text-shadow:
    0 0 4px rgba(0,255,255,0.6),
    0 0 8px rgba(0,255,255,0.4),
    0 0 12px rgba(0,255,255,0.2);
}

/* –ö–ª—é—á–æ–≤—ñ –∫–∞–¥—Ä–∏ –¥–ª—è –ø—É–ª—å—Å–∞—Ü—ñ—ó */
@keyframes glow {
  from {
    text-shadow:
      0 0 2px rgba(0,255,255,0.5),
      0 0 6px rgba(0,255,255,0.3);
  }
  to {
    text-shadow:
      0 0 8px rgba(0,255,255,1),
      0 0 16px rgba(0,255,255,0.8);
  }
}

/* –ö–ª–∞—Å –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∞–Ω—ñ–º–∞—Ü—ñ—ó */
.film-card .film-imdb.pulsate {
  animation: glow 1.5s ease-in-out infinite alternate;
}


/* –º–∞–ª–µ–Ω—å–∫–∏–π —à—Ä–∏—Ñ—Ç –¥–ª—è –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤ –ª–∞–π–∫—ñ–≤/–¥–∏–∑–ª–∞–π–∫—ñ–≤ */
.film-rating span {
  font-size: 12px;
  vertical-align: middle;
}

#genre-results {
  display: none;      /* –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  padding: 10px;
}

/* –¶–µ–Ω—Ç—Ä—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ #genres */
/* === –ì–æ–ª–æ–≤–Ω–∞: –∫–Ω–æ–ø–∫–∏ –§—ñ–ª—å–º–∏/–°–µ—Ä—ñ–∞–ª–∏/–ú—É–ª—å—Ç—Ñ—ñ–ª—å–º–∏ === */
#genres {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 15px;
  margin: 24px auto;
}

/* –±–∞–∑–æ–≤–∏–π —Å—Ç–∞–Ω */
#genres .genre-btn {
  background-color: #222;
  border: 1px solid #444;
  padding: 8px 16px;                 /* –∑–º–µ–Ω—à–∏–ª–∏ –≤—ñ–¥—Å—Ç—É–ø–∏ */
  border-radius: 20px;               /* —Ç—Ä–æ—Ö–∏ –º–µ–Ω—à—ñ –∑–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—è */
  font-size: 16px;                   /* –∑–º–µ–Ω—à–∏–ª–∏ —Ä–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É */
  font-weight: 500;
  color: #00f7ff;
  text-shadow: 0 0 5px #00f7ff;      /* –ª–µ–≥—à–∏–π –æ—Ä–µ–æ–ª */
  display: flex;
  align-items: center;
  gap: 6px;                          /* –∑–º–µ–Ω—à–∏–ª–∏ –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ —ñ–∫–æ–Ω–∫–æ—é —ñ —Ç–µ–∫—Å—Ç–æ–º */
  box-shadow:
    0 0 6px  #00f7ff,
    0 0 12px rgba(0,255,255,0.4),
    0 0 18px rgba(0,255,255,0.2);
  transition: all 0.2s ease-in-out;
}

/* –ø—ñ–¥—Å–≤—ñ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–Ω—ñ —ñ —É ‚Äú–∞–∫—Ç–∏–≤–Ω–æ–≥–æ‚Äù —Å—Ç–∞–Ω—É */
#genres .genre-btn:hover {
  color: #ccc;
  text-shadow: none;
  box-shadow: none;
}

/* üåà –Ø—Å–∫—Ä–∞–≤—ñ –¥–∏—Ç—è—á—ñ –∫–Ω–æ–ø–∫–∏ –ª–∏—à–µ –¥–ª—è "–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó ‚Üí –ú—É–ª—å—Ç–∏–∫–∏" */
#group-cartoons .genre-btn {
  border: 0;
  color: #000;
  font-weight: 800;
  padding: 10px 18px;
  border-radius: 24px;
  letter-spacing: .2px;
  box-shadow:
    0 6px 0 rgba(0,0,0,.25),
    0 0 12px rgba(255, 231, 76, .5);
  transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
}

/* üé¨ "–ú—É–ª—å—Ç—Ñ—ñ–ª—å–º–∏" (1-–∞ –∫–Ω–æ–ø–∫–∞) ‚Äî –∂–æ–≤—Ç–æ-–ø–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π –≥—Ä–∞–¥—ñ—î–Ω—Ç */
#group-cartoons .genre-btn:nth-child(1) {
  background: linear-gradient(135deg, #FFE082, #FF8F00);
}

/* üì∫ "–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª–∏" ‚Äî –Ω—ñ–∂–Ω–æ-—Ä–æ–∂–µ–≤–∏–π –≥—Ä–∞–¥—ñ—î–Ω—Ç + –±—ñ–ª–∏–π —Ç–µ–∫—Å—Ç */
#group-cartoons .genre-btn:nth-child(2) {
  background: linear-gradient(135deg, #FF9AC6, #FF4D88); /* —Ä–æ–∂–µ–≤–æ-–º–∞–ª–∏–Ω–æ–≤–∏–π */
  color: #fff;                       /* –∫—Ä–∞—â–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç –Ω–∞ —Ä–æ–∂–µ–≤–æ–º—É */
  box-shadow:
    0 6px 0 rgba(0,0,0,.25),
    0 0 12px rgba(255, 105, 180, .55); /* —Ä–æ–∂–µ–≤–µ —Å–≤—ñ—á–µ–Ω–Ω—è */
}

/* –•–æ–≤–µ—Ä/–∫–ª—ñ–∫ —Å–∞–º–µ –¥–ª—è —Ä–æ–∂–µ–≤–æ—ó */
#group-cartoons .genre-btn:nth-child(2):hover {
  filter: brightness(1.06);
  transform: translateY(-2px);
  box-shadow:
    0 8px 0 rgba(0,0,0,.25),
    0 0 18px rgba(255, 105, 180, .75);
}
#group-cartoons .genre-btn:nth-child(2):active {
  transform: translateY(0) scale(.98);
  box-shadow:
    0 4px 0 rgba(0,0,0,.25),
    0 0 10px rgba(255, 105, 180, .6);
}

/* === –ï—Ñ–µ–∫—Ç –º–∏–≥–æ—Ç—ñ–Ω–Ω—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ –§—ñ–ª—å–º–∏ / –°–µ—Ä—ñ–∞–ª–∏ / –ú—É–ª—å—Ç—Ñ—ñ–ª—å–º–∏ === */
@keyframes blink {
  0%, 100% { 
    color: #00f7ff; 
    text-shadow: 0 0 10px #00f7ff; 
    transform: scale(1.1);
  }
  50% { 
    color: #fff; 
    text-shadow: none; 
    transform: scale(1);
  }
}

.genre-btn.blink {
  animation: blink 1s ease-in-out infinite;
}
/* –î–ª—è 3-—Ö –≤–µ–ª–∏–∫–∏—Ö –∫–Ω–æ–ø–æ–∫ —É —Ä–æ–∑–¥—ñ–ª—ñ "–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó" */
.genre-main-btn.blink {
  animation: blink 1s ease-in-out infinite;
}

/* –î–ª—è –∫–Ω–æ–ø–æ–∫ —É —Ä–æ–∑–¥—ñ–ª—ñ "–ú—É–ª—å—Ç–∏–∫–∏" */
.mult-btn.blink {
  animation: blink 1s ease-in-out infinite;
}

/* –î–ª—è –∫–Ω–æ–ø–æ–∫ —É —Ä–æ–∑–¥—ñ–ª—ñ "–ú—É–ª—å—Ç–∏–∫–∏" */
.cartoon-btn.blink {
  animation: blink 1s ease-in-out infinite;
}

  </style>
 
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  
    <!-- –ü—ñ—Å–ª—è <script src="https://telegram.org/js/telegram-web-app.js"></script> -->
  <script>
    // 1) –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –ø—Ä–∞—Ü—é—î–º–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Telegram WebApp
    if (!window.Telegram || !window.Telegram.WebApp) {
      document.body.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;color:#fff;background:#111;">
          <h2>–¶–µ–π –¥–æ–¥–∞—Ç–æ–∫ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –ª–∏—à–µ –≤ Telegram</h2>
        </div>`;
      throw new Error('–ù–µ –≤–µ–±-App Telegram');
    }
    const tg = window.Telegram.WebApp;
    tg.ready();
   

    // 2) –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ –æ—Ç—Ä–∏–º–∞–ª–∏ –≤–∞–ª—ñ–¥–Ω—ñ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    const user = tg.initDataUnsafe?.user;

    if (!user || typeof user.id !== 'number' || user.id === 0) {
      document.body.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;color:#00f7ff;background:#111;padding:1em;text-align:center;">
          <h2>‚õîÔ∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—è –≤ Telegram</h2>
          <p>–ú–æ–∂–ª–∏–≤–æ, –ø—Ä–æ–±–ª–µ–º–∏ –∑ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º. –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–Ω–æ–≤—ñ—Ç—å –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫.</p>
          <button onclick="location.reload()" 
                  style="margin-top:20px;padding:12px 24px;border:none;border-radius:8px;background:#00f7ff;color:#000;font-weight:bold;cursor:pointer;">
            üîÑ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É
          </button>
        </div>`;
      throw new Error('–ù–µ–º–∞—î user.id');
    }
    // —è–∫—â–æ –≤—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—Ä–æ–π—à–ª–∏ ‚Äî –¥–∞–ª—ñ –≤–∞—à —ñ—Å–Ω—É—é—á–∏–π –∫–æ–¥...
  </script>
<!-- üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É –ø—Ä–∏ –∑–º—ñ–Ω—ñ –≤–µ—Ä—Å—ñ—ó -->
<script>
const APP_VERSION = "1.4.5";  // üî∏ –∑–º—ñ–Ω—é–π –ø—Ä–∏ –∫–æ–∂–Ω–æ–º—É –≤–µ–ª–∏–∫–æ–º—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ

try {
  const prevVersion = localStorage.getItem("app_version");
  if (prevVersion !== APP_VERSION) {
    // –û—á–∏—Å—Ç–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ, –∞–ª–µ –Ω–µ Telegram API
    localStorage.clear();
    sessionStorage.clear();
    localStorage.setItem("app_version", APP_VERSION);

    // –î–æ–¥–∞—Ç–∫–æ–≤–æ ‚Äî –æ–Ω–æ–≤–ª–µ–Ω–Ω—è WebApp DOM –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è
    setTimeout(() => {
      alert("üßπ –ó–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω–æ! –ö–µ—à –æ—á–∏—â–µ–Ω–æ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ—ó —Ä–æ–±–æ—Ç–∏ üé¨");
      location.reload(true);
    }, 300);
  }
} catch (err) {
  console.error("–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É:", err);
}
</script>

<script>
// ‚¨áÔ∏è –î–æ–¥–∞—î–º–æ —Ü—ñ –¥–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó (–≤—Å—Ç–∞–≤ –°–Æ–î–ò!)
function maskWord(word) {
  // –ú–∞—Å–∫—É—î: –≤—Å—Ç–∞–≤–ª—è—î zero-width space –º—ñ–∂ –ª—ñ—Ç–µ—Ä–∞–º–∏
  return word.split('').join('\u200B');
}
function unmaskWord(word) {
  // –ó–Ω—ñ–º–∞—î –º–∞—Å–∫—É–≤–∞–Ω–Ω—è (–ø—Ä–∏–±–∏—Ä–∞—î zero-width space)
  return word.replace(/\u200B/g, '');
}
function safeId(str, scope = '') {
  const s = `${scope}#${String(str || '')}`;
  // FNV-1a 32-bit
  let h = 2166136261;
  for (const ch of s) {
    h ^= ch.codePointAt(0);
    h = (h >>> 0) * 16777619;
  }
  return 'id_' + (h >>> 0).toString(36);
}


function renderControls(title, description) {
  const film = films.find(f => f['–ù–∞–∑–≤–∞'] === title) || {};
  return `
    <button class="favorite-btn"
      onclick='addToFavorites(${JSON.stringify(title)}, ${JSON.stringify(description || "")}, ${JSON.stringify(film.message_id || "")})'>
      üíõ
    </button>
  `;
}



// –ù–û–í–ê –≤–µ—Ä—Å—ñ—è: –Ω–µ —Å–∫–ª–µ—é—î —Ä—ñ–∑–Ω—ñ —Ä—è–¥–∫–∏ –±–µ–∑ ID/–Ω–æ–º–µ—Ä—ñ–≤
function episodeKey(ep, i) {
  const s = (ep['–°–µ–∑–æ–Ω'] ?? ep['Season'] ?? '').toString().trim();
  const e = (ep['–°–µ—Ä—ñ—è'] ?? ep['–ï–ø—ñ–∑–æ–¥'] ?? ep['Episode'] ?? '').toString().trim();
  const mid = (ep['message_id'] ?? ep['file_id'] ?? '').toString().trim();

  if (mid) return `mid:${mid}`;          // —É–Ω—ñ–∫–∞–ª—å–Ω–æ –∑–∞ —Ñ–∞–π–ª–æ–º/–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
  if (s || e) return `se:${s}|${e}`;     // —è–∫—â–æ —î —Ö–æ—á —â–æ—Å—å –∑ –Ω–æ–º–µ—Ä—ñ–≤
  return `idx:${i}`;                     // —ñ–Ω–∞–∫—à–µ ‚Äî —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å, —â–æ–± –Ω–µ —Å–∫–ª–µ—ó—Ç–∏
}

// [583‚Äì622]
function groupSeriesEpisodes(list) {
  // –ö–ª—é—á –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ (–Ω–∏–∂–Ω—ñ–π —Ä–µ–≥—ñ—Å—Ç—Ä) –ª–∏—à–µ –¥–ª—è –≥—Ä—É–ø—É–≤–∞–Ω–Ω—è,
  // –∞–ª–µ –ó–ë–ï–†–Ü–ì–ê–Ñ–ú–û –ø–µ—Ä—à–∏–π –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.
  const byNorm = new Map(); // normTitle -> { orig, map }

  for (let i = 0; i < list.length; i++) {
    const ep = list[i];
    const orig = (ep['–ù–∞–∑–≤–∞'] || '').toString().trim();
    const norm = orig.toLowerCase();

    if (!byNorm.has(norm)) {
      byNorm.set(norm, { orig, map: new Map() });
    }
    const { map } = byNorm.get(norm);

    // –ö–ª—é—á –µ–ø—ñ–∑–æ–¥—É ‚Äî —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π: (—Å–µ–∑–æ–Ω, —Å–µ—Ä—ñ—è) –∞–±–æ fallback —á–µ—Ä–µ–∑ –ø–∞—Ä—Å–µ—Ä –∑ –æ–ø–∏—Å—É
    const key = episodeKey(ep, i);
    if (!map.has(key)) {
      map.set(key, ep);
    }
  }

  const grouped = {};
  for (const { orig, map } of byNorm.values()) {
    const arr = Array.from(map.values());

    // –°–æ—Ä—Ç—É—î–º–æ: —Å–ø–µ—Ä—à—É —Å–µ–∑–æ–Ω, –¥–∞–ª—ñ —Å–µ—Ä—ñ—è; —è–∫—â–æ '–°–µ—Ä—ñ—è' –ø–æ—Ä–æ–∂–Ω—è ‚Äî –ø–∞—Ä—Å–∏–º–æ –∑ –æ–ø–∏—Å—É
    arr.sort((a, b) => {
      const sa = parseInt(a['–°–µ–∑–æ–Ω'] ?? a['Season'] ?? '1') || 1;
      const sb = parseInt(b['–°–µ–∑–æ–Ω'] ?? b['Season'] ?? '1') || 1;

      const eaRaw = a['–°–µ—Ä—ñ—è'] ?? a['–ï–ø—ñ–∑–æ–¥'] ?? a['Episode'] ?? '';
      const ebRaw = b['–°–µ—Ä—ñ—è'] ?? b['–ï–ø—ñ–∑–æ–¥'] ?? b['Episode'] ?? '';
      const ea = parseInt(eaRaw, 10);
      const eb = parseInt(ebRaw, 10);

      const eaNum = Number.isFinite(ea) ? ea : (parseEpisodeNumber(a) || 9999);
      const ebNum = Number.isFinite(eb) ? eb : (parseEpisodeNumber(b) || 9999);

      return sa !== sb ? sa - sb : eaNum - ebNum;
    });

    // –ö–ª—é—á –≥—Ä—É–ø–∏ ‚Äî –û–†–ò–ì–Ü–ù–ê–õ–¨–ù–ê –Ω–∞–∑–≤–∞ (–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º —Ä–µ–≥—ñ—Å—Ç—Ä–æ–º)
    grouped[orig] = arr;
  }

  return grouped;
}



const EPISODIC_TYPES = ['—Å–µ—Ä—ñ–∞–ª','—Å–µ—Ä—ñ–∞–ª–∏','–º—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª','–º—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª–∏'];

// ‚¨áÔ∏è —Ç–æ—á–Ω–µ –≤—Ö–æ–¥–∂–µ–Ω–Ω—è –∂–∞–Ω—Ä—É —è–∫ —Ç–æ–∫–µ–Ω–∞ (–∞ –Ω–µ –ø—ñ–¥—Ä—è–¥–∫–∞)
function hasExactGenre(value, target) {
  if (!value) return false;

  const tokens = value
    .toLowerCase()
    .split(/[,\|\/;¬∑‚Ä¢]+|\s{2,}/)  // –∫–æ–º–∞, —Å–ª–µ—à, –ø–∞–π–ø, –∫—Ä–∞–ø–∫–∏ —Ç–æ—â–æ + –ø–æ–¥–≤—ñ–π–Ω—ñ –ø—Ä–æ–±—ñ–ª–∏
    .map(s => s.trim())
    .filter(Boolean);

  const t = (target || '').toLowerCase();

  // aliases –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –Ω–∞–ø–∏—Å–∞–Ω—å/—á–∏—Å–µ–ª
  const aliases = [t];
  if (t === '–¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–∏–π') {
    aliases.push('–¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ñ', '–¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–∏–π —Å–µ—Ä—ñ–∞–ª', '–¥–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ñ —Å–µ—Ä—ñ–∞–ª–∏');
  }

  return tokens.some(tok => aliases.includes(tok));
}
function isEpisodicType(t) {
  return EPISODIC_TYPES.includes((t||'').trim().toLowerCase());
}

function episodeLabel(ep, i) {
  const e = (ep['–°–µ—Ä—ñ—è'] ?? ep['–ï–ø—ñ–∑–æ–¥'] ?? ep['Episode'] ?? '').toString().trim();
  if (e) return `–°–µ—Ä—ñ—è ${e}`;

  // —è–∫—â–æ –Ω–æ–º–µ—Ä —Å–µ—Ä—ñ—ó –≤–∏—Ç—è–≥—É—î—Ç—å—Å—è –∑ –æ–ø–∏—Å—É ‚Äî –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—î–º–æ –π–æ–≥–æ
  const n = parseEpisodeNumber(ep);
  if (Number.isFinite(n)) return `–°–µ—Ä—ñ—è ${n}`;

  // –∑–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç
  return `–°–µ—Ä—ñ—è ${i + 1}`;
}

  
function poster(src, title, year){
  return `<div class="poster-wrap">
    <img src="${src}" alt="${title}" class="film-img">
    ${year ? `<span class="year-badge">üìÖ ${year}</span>` : ''}
  </div>`;
}

function parseEpisodeNumber(ep) {
  const raw = (ep['–°–µ—Ä—ñ—è'] ?? ep['–ï–ø—ñ–∑–æ–¥'] ?? ep['Episode'] ?? '').toString().trim();
  if (raw) {
    const n = parseInt(raw, 10);
    if (!isNaN(n) && n > 0) return n;
  }
  return Infinity; // —Å–µ—Ä—ñ—è –Ω–µ –≤–∫–∞–∑–∞–Ω–∞
}


function sortByParsedEpisode(list) {
  return list
    .map((ep, i) => ({ ep, i, n: parseEpisodeNumber(ep) }))
    .sort((a, b) => (a.n - b.n) || (a.i - b.i))
    .map(x => x.ep);
}
// --- –°–ï–ó–û–ù–ò: –±–µ—Ä–µ–º–æ –∞–±–æ –∑ –ø–æ–ª—è "–°–µ–∑–æ–Ω", –∞–±–æ –∑ —Ç–µ–∫—Å—Ç—É –æ–ø–∏—Å—É (fallback) ---
function getSeasonNum(ep){
  const raw = (ep['–°–µ–∑–æ–Ω'] ?? ep['Season'] ?? '').toString().trim();
  if (raw) { 
    const n = parseInt(raw, 10); 
    if (!isNaN(n) && n > 0) return n; 
  }
  return 1; // —è–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ–º–∞—î
}


function groupBySeason(list){
  const map = {};
  for (const ep of list){
    const s = getSeasonNum(ep);
    (map[s] ||= []).push(ep);
  }
  for (const k of Object.keys(map)){
    map[k] = sortByParsedEpisode(map[k].slice()); // —Å–µ—Ä—ñ—ó —Å–æ—Ä—Ç—É—î–º–æ –ø–æ –Ω–æ–º–µ—Ä—É –∑ description
  }
  return map;
}

// –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —Ä–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–∫–∏ —Å–µ—Ä—ñ–∞–ª—É (–∑ —Å–µ–∑–æ–Ω–∞–º–∏ –∞–±–æ –±–µ–∑)
function renderSeriesCard(title, episodes){
  const safe   = safeId(title, 'series');
  const count  = episodes.length;
  const first  = episodes[0] || {};
  const isPro  = localStorage.getItem('isProUser') === 'true';
  // —è–∫—â–æ –≤ —Ç–∞–π—Ç–ª—ñ —î –•–û–ß –û–î–ù–ê –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ —Å–µ—Ä—ñ—è ‚Äî –Ω–µ –ª–æ—á–∏–º–æ –∫–∞—Ä—Ç–∫—É
  const hasFree = episodes.some(ep => ep['–î–æ—Å—Ç—É–ø'] !== 'PRO');
  const locked  = !hasFree && !isPro;


  const posterSrc = locked ? placeholderImage : (first['–§–æ—Ç–æ'] || placeholderImage);
  const imdb   = first['IMDb'] || '‚Äî';
  const year   = first['–†—ñ–∫'];

  const seasonsMap = groupBySeason(episodes);
  const seasons = Object.keys(seasonsMap).map(n=>parseInt(n,10)).sort((a,b)=>a-b);

  // 1 —Å–µ–∑–æ–Ω ‚Üí –ø–æ–∫–∞–∑—É—î–º–æ –æ–¥—Ä–∞–∑—É —Å–µ—Ä—ñ—ó
  if (seasons.length <= 1){
    const eps = seasons.length ? seasonsMap[seasons[0]] : sortByParsedEpisode(episodes);
    return `
      <div class="film-card" id="film-${safe}">
        ${poster(posterSrc, title, year)}
        <h3>${maskWord(title)}</h3>
        <p class="film-imdb">IMDb: ${imdb}</p>
        ${renderControls(title, first['–û–ø–∏—Å'] || '')}
        <button class="search-button" onclick="toggleEpisodes('${safe}', this)" data-count="${count}">
          üì∫ –ü–æ–∫–∞–∑–∞—Ç–∏ —Å–µ—Ä—ñ—ó (${count})
        </button>
        <div id="episodes-${safe}" class="series-episodes-grid" data-count="${count}" style="display:none;">
          ${eps.map((ep,i)=>{
            const label = episodeLabel(ep,i);
            const mid = ep.message_id || ep.file_id;
            const ch  = ep.channel_id || ''; 

            return locked
              ? `<button class="search-button" onclick="showProModal()">üîí PRO</button>`
              : (mid
                 ? `<button class="search-button" onclick="requestFilmByName(this,'${mid}','${ch}')">${label}</button>`
                 : `<button class="search-button" onclick="openVideoById(this,'${title}')">${label}</button>`);
            }).join('')}
        </div>
      </div>
    `;
  }

  // –ö—ñ–ª—å–∫–∞ —Å–µ–∑–æ–Ω—ñ–≤ ‚Üí —Ç–∞–±–∏
return `
  <div class="film-card" id="film-${safe}">
    ${poster(posterSrc, title, year)}
    <h3>${maskWord(title)}</h3>
    <p class="film-imdb">IMDb: ${imdb}</p>
    ${renderControls(title, first['–û–ø–∏—Å'] || '')}

    <button class="search-button" onclick="toggleEpisodes('${safe}', this)" data-count="${count}">
      üìö –ü–æ–∫–∞–∑–∞—Ç–∏ —Å–µ–∑–æ–Ω–∏ (${seasons.length})
    </button>

    <div id="seasonswrap-${safe}" data-count="${count}" style="display:none;">
      <div class="seasons-row" id="seasons-${safe}">
        ${seasons.map(s => `
          <button class="season-btn" onclick="toggleSeason('${safe}', ${s})">–°–µ–∑–æ–Ω ${s}</button>
        `).join('')}
      </div>

      ${seasons.map(s => {
        const list = seasonsMap[s];
        return `
          <div class="series-episodes-grid series-episodes-season" id="episodes-${safe}-s${s}" style="display:none;">
            ${list.map((ep,i) => {
              const label = episodeLabel(ep,i);
              const mid = ep.message_id || ep.file_id;
              const ch  = ep.channel_id || '';  

              return locked
                ? `<button class="search-button" onclick="showProModal()">üîí PRO</button>`
                : (mid
                   ? `<button class="search-button" onclick="requestFilmByName(this,'${mid}','${ch}')">${label}</button>`
                   : `<button class="search-button" onclick="openVideoById(this,'${title}')">${label}</button>`);
              }).join('')}
          </div>
        `;
      }).join('')}
    </div>
  </div>
`;

}

 
function toggleSeason(seriesId, season) {
  const row = document.getElementById(`seasons-${seriesId}`);
  if (!row) return;

  // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ active –∑ —É—Å—ñ—Ö –∫–Ω–æ–ø–æ–∫
  row.querySelectorAll('.season-btn').forEach(b => b.classList.remove('active'));

  // –ê–∫—Ç–∏–≤—É—î–º–æ –≤–∏–±—Ä–∞–Ω–∏–π —Å–µ–∑–æ–Ω
  const btn = Array.from(row.querySelectorAll('.season-btn'))
    .find(b => (b.textContent || '').replace(/\D/g, '') === String(season));
  if (btn) btn.classList.add('active');

  // –•–æ–≤–∞—î–º–æ –≤—Å—ñ —Å–µ–∑–æ–Ω–∏
  const allSeasons = document.querySelectorAll(`#film-${seriesId} .series-episodes-season`);
  allSeasons.forEach(el => el.style.display = 'none');

  // –ü–æ–∫–∞–∑—É—î–º–æ –ª–∏—à–µ –≤–∏–±—Ä–∞–Ω–∏–π
  const grid = document.getElementById(`episodes-${seriesId}-s${season}`);
  if (grid) grid.style.display = 'grid';

  // üìú –ü—Ä–æ–∫—Ä—É—á—É—î–º–æ –¥–æ –ø–æ—á–∞—Ç–∫—É —Å–µ—Ä—ñ–π —Ü—å–æ–≥–æ —Å–µ–∑–æ–Ω—É
  grid?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}


</script>

</head>
<body>
  <div id="home" class="section active">
    <h2>üéØ –¢–æ–ø –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h2>
   <div id="film-of-the-day" class="film-day-card">
  <div class="image-wrapper" style="position: relative;">
    <img id="film-day-img" src="" alt="–¢–æ–ø –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ">
    <div class="film-title-overlay" id="film-title">–ù–∞–∑–≤–∞ —Ñ—ñ–ª—å–º—É</div>
  </div>
  <div class="btn-container">
    <button id="openVideoById" class="watch-btn">üëÄ –ü–æ–≥–ª—è–Ω—É—Ç–∏</button>
  </div>
</div>





      <div id="home-loading" style="text-align:center; margin-top:30px;">
    <span class="loader"></span>
    <div style="margin-top:8px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
  </div>

    
    <h3>–†–æ–∑–¥—ñ–ª–∏</h3>
    <div id="genres" style="display:none; flex-wrap:wrap; gap:10px;"></div>
    

    <h3 style="margin-top:25px">–î–æ–±—ñ—Ä–∫–∏</h3>
  <div id="collections" style="
  display: flex;
  flex-wrap: nowrap;
  overflow-x: auto;
  gap: 16px;
  padding: 10px 0;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
"></div>

    </div>
  

  <div id="categories" class="section">
<h2>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</h2>
<button class="back-button" onclick="switchTab('home', document.querySelector('[data-tab=home]'))">
  ‚¨ÖÔ∏è –ù–∞–∑–∞–¥
</button>

<div class="genre-main-wrapper" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
  <button class="genre-main-btn" onclick="openGenreGroup('films')">
    üéØ –§—ñ–ª—å–º–∏ –∑–∞ –∂–∞–Ω—Ä–æ–º
  </button>
  <button
    class="genre-main-btn"
    onclick="
      switchTab('categories', document.querySelector('[data-tab=categories]'));
      openGenreGroup('series');
      showSeries('–°–µ—Ä—ñ–∞–ª');
    "
  >
    üì∫ –°–µ—Ä—ñ–∞–ª–∏
  </button>
  <button class="genre-main-btn" onclick="openGenreGroup('cartoons')">
    üëß –ú—É–ª—å—Ç–∏–∫–∏
  </button>
</div>




  

   <!-- üîΩ –ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: –ó–∞ –∂–∞–Ω—Ä–æ–º -->
<div id="group-films" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="–ï–∫—à–Ω(–±–æ–π–æ–≤–∏–∫–∏)">üî´ –ï–∫—à–Ω</button>
  <button class="genre-btn" data-genre="–ö–æ–º–µ–¥—ñ—ó">üòÇ –ö–æ–º–µ–¥—ñ—ó</button>
  <button class="genre-btn" data-genre="–î–µ—Ç–µ–∫—Ç–∏–≤">üïµÔ∏è –î–µ—Ç–µ–∫—Ç–∏–≤</button>
  <button class="genre-btn" data-genre="–î—Ä–∞–º–∏">üé≠ –î—Ä–∞–º–∏</button>
  <button class="genre-btn" data-genre="–í—ñ–π—Å—å–∫–æ–≤—ñ">ü™ñ –í—ñ–π—Å—å–∫–æ–≤—ñ</button>
  <button class="genre-btn" data-genre="–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞">üëΩ –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</button>
  <button class="genre-btn" data-genre="–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–∏–π">üìö –î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–∏–π</button>
  <button class="genre-btn" data-genre="–¢—Ä–∏–ª–µ—Ä–∏">üò± –¢—Ä–∏–ª–µ—Ä–∏</button>
  <button class="genre-btn" data-genre="–°—ñ–º–µ–π–Ω—ñ">üë®‚Äçüë©‚Äçüëß –°—ñ–º–µ–π–Ω—ñ</button>
  <button class="genre-btn" data-genre="–ú–µ–ª–æ–¥—Ä–∞–º–∏">üíî –ú–µ–ª–æ–¥—Ä–∞–º–∏</button>
  <button class="genre-btn" data-genre="–ö—Ä–∏–º—ñ–Ω–∞–ª">üöî –ö—Ä–∏–º—ñ–Ω–∞–ª</button>
  <button class="genre-btn" data-genre="–§–µ–Ω—Ç–µ–∑—ñ">üßù –§–µ–Ω—Ç–µ–∑—ñ</button>
  <button class="genre-btn" data-genre="–ü—Ä–∏–≥–æ–¥–∏">üåç –ü—Ä–∏–≥–æ–¥–∏</button>
  <button class="genre-btn" data-genre="–Ü—Å—Ç–æ—Ä–∏—á–Ω—ñ">üè∞ –Ü—Å—Ç–æ—Ä–∏—á–Ω—ñ</button>
  <button class="genre-btn" data-genre="–†–æ–º–∞–Ω—Ç–∏—á–Ω—ñ">üíò –†–æ–º–∞–Ω—Ç–∏—á–Ω—ñ</button>
  <button class="genre-btn" data-genre="–ñ–∞—Ö–∏">üëª –ñ–∞—Ö–∏</button>
</div>

<!-- üîΩ –ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: –°–µ—Ä—ñ–∞–ª–∏ -->
<div id="group-series" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="–£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫—ñ</button>
  <button class="genre-btn" data-genre="–î–µ—Ç–µ–∫—Ç–∏–≤–Ω—ñ">üïµÔ∏è‚Äç‚ôÄÔ∏è –î–µ—Ç–µ–∫—Ç–∏–≤–Ω—ñ</button>
  <button class="genre-btn" data-genre="–î—Ä–∞–º–∞—Ç–∏—á–Ω—ñ">üé≠ –î—Ä–∞–º–∞—Ç–∏—á–Ω—ñ</button>
  <button class="genre-btn" data-genre="–ü—Ä–∏–≥–æ–¥–Ω–∏—Ü—å–∫—ñ">üåÑ –ü—Ä–∏–≥–æ–¥–Ω–∏—Ü—å–∫—ñ</button>
  <button class="genre-btn" data-genre="–ö–æ–º–µ–¥—ñ–π–Ω—ñ">üòÇ –ö–æ–º–µ–¥—ñ–π–Ω—ñ</button>
  <button class="genre-btn" data-genre="–î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–∏–π">üìö –î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ñ</button>
  <button class="genre-btn" data-genre="–ú–µ–ª–æ–¥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ ">üíî –ú–µ–ª–æ–¥—Ä–∞–º–∞—Ç–∏—á–Ω—ñ </button>
  <button class="genre-btn" data-genre="–Ü—Å—Ç–æ—Ä–∏—á–Ω—ñ —Å–µ—Ä—ñ–∞–ª–∏">üè∞ –Ü—Å—Ç–æ—Ä–∏—á–Ω—ñ —Å–µ—Ä—ñ–∞–ª–∏</button>
  <button class="genre-btn" data-genre="–§–∞–Ω—Ç–∞—Å—Ç–∏—á–Ω—ñ">üëΩ –§–∞–Ω—Ç–∞—Å—Ç–∏—á–Ω—ñ</button>
  <button class="genre-btn" data-genre="–ö—Ä–∏–º—ñ–Ω–∞–ª—å–Ω—ñ">üöî –ö—Ä–∏–º—ñ–Ω–∞–ª—å–Ω—ñ</button>
</div>

<!-- üîΩ –ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó: –ú—É–ª—å—Ç–∏–∫–∏ -->
<div id="group-cartoons" class="genre-button-container genre-scroll" style="display:none; margin-top:20px;">
  <button class="genre-btn" data-genre="–ú—É–ª—å—Ç—Ñ—ñ–ª—å–º–∏">üé¨ –ú—É–ª—å—Ç—Ñ—ñ–ª—å–º–∏</button>
  <button class="genre-btn" onclick="
    switchTab('categories', document.querySelector('[data-tab=categories]'));
    openGenreGroup('cartoons');
    showSeries(['–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª','–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª–∏']);
    return false;
  ">üì∫ –ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª–∏</button>
</div>

   <!-- üîç –§—ñ–ª—å—Ç—Ä –∑–∞ –∫—Ä–∞—ó–Ω–æ—é —Ç–∞ —Ä–æ–∫–æ–º -->
<details id="filter-details" style="margin-top: 20px; margin-bottom: 20px; background: #1c1c1c; border-radius: 10px; padding: 10px 15px;">
  <summary style="font-size: 18px; font-weight: bold; cursor: pointer; margin-bottom: 10px; color: #00f7ff;">üîé –§—ñ–ª—å—Ç—Ä–∏</summary>
  <div style="padding-top: 10px;">
    <h4 style="margin: 10px 0 5px; color: #ccc;">üåç –ö—Ä–∞—ó–Ω–∞</h4>
    <div id="country-filters" style="
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      max-height: 100px;
      overflow-y: auto;
    "></div>

    <h4 style="margin: 10px 0 5px; color: #ccc;">üìÖ –†—ñ–∫</h4>
    <div id="year-filters" style="
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-height: 100px;
      overflow-y: auto;
    "></div>
  </div>
</details>
    <div id="genre-results"></div>
    <div id="list-end-sentinel"></div>

  </div>

</div>


  <div id="favorites" class="section">
  <h2>–£–ª—é–±–ª–µ–Ω–µ</h2>
  <button class="back-button" onclick="switchTab('account', document.querySelector('[data-tab=account]'))">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
  <div id="fav-list" class="film-list" style="display: none;"></div>
</div>


  <div id="search" class="section">
    <h2>–ü–æ—à—É–∫</h2>
    <button class="back-button" onclick="switchTab('home', document.querySelector('[data-tab=home]'))">‚¨ÖÔ∏è –ù–∞–∑–∞–¥</button>
    <input type="text" id="searchInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –∞–±–æ –∂–∞–Ω—Ä..." style="width:100%;padding:10px;">
    <div id="searchResults" style="margin-top: 20px;"></div>
  </div>
<!-- ‚úÖ –°–µ–∫—Ü—ñ—è –ê–∫–∞—É–Ω—Ç -->
<section id="account" class="section">
  <h2>üë§ –ê–∫–∞—É–Ω—Ç</h2>

  <hr style="margin: 20px 0; border-color: #444;">
  <h3>üîí PRO –î–æ—Å—Ç—É–ø</h3>
  <p style="font-size:14px; color:#ccc;">–í—ñ–¥–∫—Ä–∏–≤–∞—î –¥–æ—Å—Ç—É–ø –¥–æ –≤—Å—ñ—Ö –≤—ñ–¥–µ–æ</p>
  <button id="getProBtn" class="account-button" style="background:#00f7ff; color:#000; font-weight:bold;">üöÄ –û—Ç—Ä–∏–º–∞—Ç–∏ PRO</button>
  <p class="pro-amount-glow">
  üí≥ –ë—É–¥—å-—è–∫–∞ —Å—É–º–∞ <span>(–≤—ñ–¥ 20 –≥—Ä–Ω)</span> ‚Äî <strong>PRO –¥–æ—Å—Ç—É–ø</strong>
</p>


  <button id="confirmPaidBtn" class="account-button" style="background:#00f7ff; color:#000; font-weight:bold; display:none;">
    ‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–≤
  </button>


  <!-- –î–æ–¥–∞–π —Ü—é –∫–Ω–æ–ø–∫—É —É –ø—Ä–æ—Ñ—ñ–ª—å (–∞–∫–∫–∞—É–Ω—Ç) -->
  <div id="contact-admin-section" style="margin: 18px 0;">
    <button id="contact-admin-btn" class="account-button" style="background:#00f7ff; color:#000; font-weight:bold;">
      ‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç–∏ –∞–¥–º—ñ–Ω—É
    </button>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—É -->
  <div id="admin-message-modal" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6)">
    <div style="background:#222; color:#fff; border-radius:18px; padding:24px; width:96vw; max-width:420px; margin:10vh auto; display:flex; flex-direction:column;">
      <textarea id="admin-message-text" rows="5" placeholder="–í–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É" style="resize:none; padding:12px; border-radius:10px; font-size:15px;"></textarea>
      <button id="send-admin-message-btn" style="margin-top:13px; background:#0ac075; color:#fff; border:none; border-radius:10px; padding:9px 0; font-weight:600; font-size:17px;">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
      <button id="close-admin-modal-btn" style="margin-top:8px; background:#d52a43; color:#fff; border:none; border-radius:10px; padding:9px 0; font-size:15px;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
   </div>
  </div>
 
 <!-- üöÄ Launcher: –ø–µ—Ä–µ—Ö—ñ–¥ –¥–æ –ª–∞—É–Ω—á–µ—Ä-–±–æ—Ç–∞ -->
<div id="launcher-section" style="margin: 12px 0;">
  <button id="launcher-btn"
          class="account-button"
          style="background:#00f7ff; color:#000; font-weight:bold;">
    üöÄ –û—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Launcher
  </button>
</div>



<hr style="margin: 20px 0; border-color: #444;">



<div style="margin: 20px 0;">
  <label for="theme-toggle" style="font-weight: bold;">üåô –¢–µ–º–Ω–∞ —Ç–µ–º–∞</label>
  <input type="checkbox" id="theme-toggle" />
</div>


  <!-- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –ø—Ä–æ–µ–∫—Ç—É -->
  <h3>ü§ù –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–æ—î–∫—Ç</h3>
  <div style="margin: 12px 0; text-align: center;">
    <a href="https://send.monobank.ua/jar/8G3rv7edqZ"
       target="_blank"
       class="btn-donate"
       style="margin-right:8px;">
      ‚òï –ù–∞ –∫–∞–≤—É –∞–¥–º—ñ–Ω—É
    </a>
  </div>

 

</section>

  <div class="nav">
    <button class="nav-btn" data-tab="account">üë§<span>–ê–∫–∞—É–Ω—Ç</span></button>
    <button class="nav-btn active" data-tab="home">üè†<span>–ì–æ–ª–æ–≤–Ω–∞</span></button>
    <button class="nav-btn" data-tab="categories">üéûÔ∏è<span>–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</span></button>
    <button class="nav-btn" data-tab="favorites">üíõ<span>–£–ª—é–±–ª–µ–Ω–µ</span></button>
    <button class="nav-btn" data-tab="search">üîç<span>–ü–æ—à—É–∫</span></button>
  </div>

  <div id="loading-indicator" style="display: none;">
  <div class="loader"></div>
  <div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—É...</div>
    
</div>
<div id="payment-loading" style="
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.55);
  z-index: 9999;
  display: none;
  justify-content: center;
  align-items: center;
">
  <div style="text-align:center;">
    <div class="loader"></div>
    <div style="margin-top: 12px; color: #00f7ff;">
      –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –æ–ø–ª–∞—Ç—É...<br>
      <span style="font-size:13px;color:#aaa;">–Ø–∫—â–æ –Ω–µ —Å–ø—Ä–∞—Ü—é—î ‚Äî –∑–∞—á–µ–∫–∞–π—Ç–µ 10-15 —Å–µ–∫ —ñ –ø–æ–≤—Ç–æ—Ä—ñ—Ç—å —â–µ —Ä–∞–∑.</span>
    </div>
  </div>
</div>

<div id="request-loading" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
">
  <div style="text-align:center;">
    <div class="loader"></div>
    <div style="margin-top: 10px; color:#00f7ff;">–ù–∞–¥—Å–∏–ª–∞—î–º–æ –∑–∞–ø–∏—Ç‚Ä¶</div>
  </div>
</div>



  <script>

    const placeholderImage = "https://i.postimg.cc/6q9Cd9sQ/d9d66124-1900-49be-a89c-007edc35bd13.png";
    
    let films = [];
    let isDataLoaded = false;
    let proPollInterval = null;

    const BATCH_SIZE = 50;
    let currentFilms = [];
    let offset = 0;
    
  function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function renderBatch() {
  const container = document.getElementById('genre-results');
  container.style.display = 'grid';
  const isPro = localStorage.getItem('isProUser') === 'true';
  const batch = currentFilms.slice(offset, offset + BATCH_SIZE);

  const html = batch.map(film => {
    const isProFilm = film['–î–æ—Å—Ç—É–ø'] === 'PRO';
    const imgSrc    = (isProFilm && !isPro)
                      ? placeholderImage
                      : (film['–§–æ—Ç–æ'] || placeholderImage);
    const id        = safeId(film['–ù–∞–∑–≤–∞'], 'catalog');

   let btn = '';
   if (isProFilm && !isPro) {
     btn = `<button class="search-button" onclick="showProModal()">üîí PRO –î–æ—Å—Ç—É–ø</button>`;
    } else if (film['message_id'] || film['file_id']) {
     const mid = film['message_id'] || film['file_id'];
     btn = `<button class="search-button" onclick="requestFilmByName(this, '${film.message_id}', '${film.channel_id}')">‚ñ∂Ô∏è –î–∏–≤–∏—Ç–∏—Å—å</button>`;
    }

    return `
      <div class="film-card" id="film-${id}">
        ${poster(imgSrc, film['–ù–∞–∑–≤–∞'], film['–†—ñ–∫'])}
        <h3>${maskWord(film['–ù–∞–∑–≤–∞'])}</h3>
        <p class="film-imdb">IMDb: ${film['IMDb'] || '‚Äî'}</p>
        <p>${film['–û–ø–∏—Å'] || ''}</p>
        <div class="film-actions">
          ${renderControls(film['–ù–∞–∑–≤–∞'], film['–û–ø–∏—Å'])}
          ${btn}
        </div>
      </div>
    `;
  }).join('');

  container.insertAdjacentHTML('beforeend', html);
  offset += batch.length;
}

// ==== SUPABASE (–ø—ñ–¥—Å—Ç–∞–≤ —Å–≤–æ—ó –∑–Ω–∞—á–µ–Ω–Ω—è) ====
const SUPABASE_URL  = 'https://zerlqvbmqszomlondlte.supabase.co'; // –ø–µ—Ä–µ–≤—ñ—Ä —Ç–æ—á–Ω–∏–π URL!
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplcmxxdmJtcXN6b21sb25kbHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzg3NzQsImV4cCI6MjA3MDkxNDc3NH0.8wUBYIeQRC6KVp6vdzv0oqofIf4PeZyzbV5GcD0vxTE';              // Settings ‚Üí API ‚Üí anon public

// —á–∏—Ç–∞—î–º–æ REST‚Äô–æ–º —ñ –º–∞–ø–∏–º–æ —É —Å—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç –∑ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–º–∏ –∫–ª—é—á–∞–º–∏
async function fetchFilmsFromSupabase() {
  const pageSize = 1000;
  const base = `${SUPABASE_URL}/rest/v1/films?select=id,title,type,genre,description,photo,message_id,file_id,channel_id,collection,country,year,access,imdb,season,episode&order=title.asc,season.asc,episode.asc,id.asc`;

  let rows = [];
  for (let pageOffset = 0; ; pageOffset += pageSize) {
    const res = await fetch(`${base}&limit=${pageSize}&offset=${pageOffset}`, {
      headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` }
    });
    if (!res.ok) throw new Error('Supabase fetch failed: ' + (await res.text()));
    const batch = await res.json();
    rows = rows.concat(batch);
    if (batch.length < pageSize) break; // –æ—Å—Ç–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∞
  }

  // –ú–∞–ø—ñ–Ω–≥ —É –≤–∞—à —Å—Ç–∞—Ä–∏–π —Ñ–æ—Ä–º–∞—Ç –∑ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∏–º–∏ –∫–ª—é—á–∞–º–∏
  return rows.map(r => ({
    'id': r.id ?? '',
    '–ù–∞–∑–≤–∞'      : r.title ?? '',
    '–¢–∏–ø'        : r.type ?? '',
    '–ñ–∞–Ω—Ä'       : r.genre ?? '',
    '–û–ø–∏—Å'       : r.description ?? '',
    '–§–æ—Ç–æ'       : r.photo ?? '',
    'IMDb'       : r.imdb ?? '',
    '–î–æ–±—ñ—Ä–∫–∞'    : r.collection ?? '',
    '–î–æ—Å—Ç—É–ø'     : r.access ?? '',
    '–ö—Ä–∞—ó–Ω–∞'     : r.country ?? '',
    '–†—ñ–∫'        : r.year ?? '',
    'message_id' : r.message_id ?? '',
    'file_id'    : r.file_id ?? '',
    'channel_id' : r.channel_id ?? '',
    '–°–µ—Ä—ñ—è'      : r.episode ?? '',
    '–°–µ–∑–æ–Ω'      : r.season ?? ''
    
   
    
  }));
}

    

// (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ) –∑–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç ‚Äî —Ç–≤—ñ–π —Å—Ç–∞—Ä–∏–π Google Sheet
async function fetchFilmsFromGoogle() {
  const url = `https://opensheet.vercel.app/1LlkMITwr1sXyQI_jmfhrhEPXB2L22MCh8GIXNm5aoTQ/Sheet1?cb=${Date.now()}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('Google fetch failed: ' + res.status);
  return await res.json();
}

// —î–¥–∏–Ω–∞ —Ç–æ—á–∫–∞: –ø—Ä–æ–±—É—î–º–æ Supabase ‚Üí —è–∫—â–æ –≤–ø–∞–≤, –π–¥–µ–º–æ –≤ Google
async function fetchFilms() {
  try { return await fetchFilmsFromSupabase(); }
  catch (e) {
    console.warn('Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π, fallback –¥–æ Google:', e);
    return await fetchFilmsFromGoogle();
  }
}

async function loadFilms() {
  const cached = localStorage.getItem('films');

  // 1) –Ø–∫—â–æ —î –∫–µ—à ‚Äî –º–∏—Ç—Ç—î–≤–æ —Ä–µ–Ω–¥–µ—Ä–∏–º–æ –∑ –Ω—å–æ–≥–æ
  if (cached) {
    films = JSON.parse(cached);
    shuffleArray(films);

    showFilmOfTheDay();
    showCollections();
    showGenres();
    startBlinkingGenres(); // –∑–∞–ø—É—Å–∫–∞—î–º–æ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è
    startBlinkingCategories(); // üöÄ –∑–∞–ø—É—Å–∫–∞—î–º–æ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
    startBlinkingCartoons(); // üöÄ –∑–∞–ø—É—Å–∫–∞—î–º–æ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è –¥–ª—è "–ú—É–ª—å—Ç–∏–∫–∏"
    showCountryFilters();
    showYearFilters();

    isDataLoaded = true;
    currentFilms = films;
    offset = 0;
    document.getElementById('genre-results').innerHTML = '';
    renderBatch();
  } else {
    // –Ø–∫—â–æ –∫–µ—à—É –Ω–µ–º–∞—î ‚Äî –º–æ–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ —Å–ø—ñ–Ω–µ—Ä (—è–∫—â–æ —Ö–æ—á–µ—Ç–µ)
    const loader = document.getElementById('home-loading');
    if (loader) loader.style.display = 'block';
  }

  // 2) –ó–∞–≤–∂–¥–∏ –ø—Ä–æ–±—É—î–º–æ –ø—ñ–¥—Ç—è–≥–Ω—É—Ç–∏ —Å–≤—ñ–∂–µ —É —Ñ–æ–Ω—ñ
  try {
    const fresh = await fetchFilms();   // ‚Üê —ñ –≤—Å–µ

    if (Array.isArray(fresh) && fresh.length) {
      films = fresh;
      shuffleArray(films);
      localStorage.setItem('films', JSON.stringify(films));
      localStorage.setItem('filmsTimestamp', Date.now().toString());

      // –ª–µ–≥–∫–∏–π –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä –∞–∫—Ç—É–∞–ª—å–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏
      document.getElementById('genre-results').innerHTML = '';
      currentFilms = films;
      offset = 0;
      renderBatch();
      showFilmOfTheDay();
      showCollections();
      showCountryFilters();
      showYearFilters();
    }
  } catch (e) {
    console.warn('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ –∑ –º–µ—Ä–µ–∂—ñ:', e);
  } finally {
    const loader = document.getElementById('home-loading');
    if (loader) loader.style.display = 'none';
    isDataLoaded = true;
  }
}




async function fetchAndUpdateFilms() {
  try {
    document.getElementById('home-loading').style.display = 'block';

    const loadedFilms = await fetchFilms();   // ‚Üê —ñ –≤—Å–µ


    if (!loadedFilms || loadedFilms.length === 0) {
      throw new Error('–û—Ç—Ä–∏–º–∞–Ω–æ –ø—É—Å—Ç–∏–π —Å–ø–∏—Å–æ–∫ —Ñ—ñ–ª—å–º—ñ–≤');
    }

    films = loadedFilms;
    shuffleArray(films);

    localStorage.setItem('films', JSON.stringify(films));
    localStorage.setItem('filmsTimestamp', Date.now().toString());

    showFilmOfTheDay();
    showCollections();
    showGenres();
    startBlinkingGenres(); // –∑–∞–ø—É—Å–∫–∞—î–º–æ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è
    startBlinkingCategories(); // üöÄ –∑–∞–ø—É—Å–∫–∞—î–º–æ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
    startBlinkingCartoons(); // üöÄ –∑–∞–ø—É—Å–∫–∞—î–º–æ –º–∏–≥–æ—Ç—ñ–Ω–Ω—è –¥–ª—è "–ú—É–ª—å—Ç–∏–∫–∏"
    showCountryFilters();
    showYearFilters();
  } catch (error) {
    console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—ñ–≤:', error);

    const cached = localStorage.getItem('films');
    if (!cached || JSON.parse(cached).length === 0) {
      showServiceErrorModal("‚ö†Ô∏è –í–∏–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ –∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º. –°–ø—Ä–æ–±—É–π –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫.");
      localStorage.removeItem('films');
      localStorage.removeItem('filmsTimestamp');
    }
  } finally {
    document.getElementById('home-loading').style.display = 'none';
  }
}





let pendingLink = "";

// –í–∏–∫–ª–∏–∫ –∑ —Ä–æ–∑–º—ñ—Ç–∫–∏: openVideoById(this, '–ù–∞–∑–≤–∞ —Ñ—ñ–ª—å–º—É')
// –Ø–∫—â–æ –Ω–µ –∑ –∫–Ω–æ–ø–∫–∏:  openVideoById(null, '–ù–∞–∑–≤–∞ —Ñ—ñ–ª—å–º—É')
async function openVideoById(btn, filmName) {
  const tg = window.Telegram?.WebApp;
  const user = tg?.initDataUnsafe?.user;
  if (!user || !user.id) {
    alert("‚ùóÔ∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à Telegram ID. –í—ñ–¥–∫—Ä–∏–π –±–æ—Ç —ñ –Ω–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É '–í–µ–±-–∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫' —â–µ —Ä–∞–∑.");
    console.error("‚ùå Telegram WebApp user data:", tg?.initDataUnsafe);
    return;
  }
  console.log("üì± USER_ID =", user.id);

  // üîí –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ PRO
  const isPro = localStorage.getItem('isProUser') === 'true';
  const film = films.find(f => f['–ù–∞–∑–≤–∞'] === filmName);
  if (film?.['–î–æ—Å—Ç—É–ø'] === 'PRO' && !isPro) {
    showProPrompt();
    return;
  }

  // –∞–Ω—Ç–∏-—Å–ø–∞–º: –±–ª–æ–∫—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ü—é –∫–Ω–æ–ø–∫—É
  if (btn?.dataset.sending === '1') return;
  if (btn) { btn.dataset.sending = '1'; btn.disabled = true; }

  const loader = document.getElementById("loading-indicator");
  if (loader) loader.style.display = "block";

  try {
    const response = await fetch('https://relax-time2.onrender.com/send-film', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: user.id, film_name: filmName })
    });
    const data = await response.json();

    if (data.success) {
      showRedirectButton();
    } else {
      showServiceErrorModal(`‚ùóÔ∏è ${data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'}`,
        () => openVideoById(btn, filmName));
    }
  } catch (error) {
    console.error('‚ùóÔ∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ:', error);
    showServiceErrorModal("‚ùóÔ∏è –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ.<br>–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",
      () => openVideoById(btn, filmName));
  } finally {
    if (loader) loader.style.display = "none";
    if (btn) { btn.dataset.sending = '0'; btn.disabled = false; }
  }
}

// –í–∏–∫–ª–∏–∫ –∑ —Ä–æ–∑–º—ñ—Ç–∫–∏: requestFilmByName(this, messageId)
async function requestFilmByName(button, msgId, channelId) {
  try {
    const telegramUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
    if (!telegramUser || !telegramUser.id) {
      alert("‚ùóÔ∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à Telegram ID. –í—ñ–¥–∫—Ä–∏–π –±–æ—Ç —ñ –Ω–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É '–í–µ–±-–∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫' –ø–æ–≤—Ç–æ—Ä–Ω–æ.");
      console.error("‚ùå Telegram user not found:", window.Telegram?.WebApp?.initDataUnsafe);
      return;
    }

    const userId = telegramUser.id;
    console.log("üì± USER_ID =", userId);


    const res = await fetch("https://relax-time2.onrender.com/send-film-id", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        message_id: msgId,
        channel_id: channelId
      })
    });

    const data = await res.json();

    if (data.success && data.url) {
      // üöÄ –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –∫–∞–Ω–∞–ª –Ω–∞–ø—Ä—è–º—É —á–µ—Ä–µ–∑ Telegram API
      if (window.Telegram?.WebApp?.openTelegramLink) {
        window.Telegram.WebApp.openTelegramLink(data.url);
      } else {
        window.location.href = data.url;
      }
    } else {
      alert(data.error || "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ –≤—ñ–¥–µ–æ");
    }

  } catch (error) {
    console.error("‚ùó –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É:", error);
    alert("‚ö†Ô∏è –í—ñ–¥–µ–æ —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ");
  }
}

    
function showRedirectButton() {
  const videoWrapper = document.getElementById('video-wrapper');
  videoWrapper.innerHTML = ''; // –æ—á–∏—â–∞—î–º–æ –≤—ñ–∫–Ω–æ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É

  const message = document.createElement('div');
  message.textContent = "‚úÖ –§—ñ–ª—å–º –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ!";
  message.style.marginTop = "10px";
  message.style.color = "#00f7ff";
  message.style.fontSize = "18px";
  message.style.fontWeight = "bold";

  const buttonsWrapper = document.createElement('div');
  buttonsWrapper.style.display = 'flex';
  buttonsWrapper.style.gap = '15px';
  buttonsWrapper.style.marginTop = '20px';
  buttonsWrapper.style.justifyContent = 'center';
  buttonsWrapper.style.flexWrap = 'wrap';

  // –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –±–æ—Ç–∞"
  const confirmButton = document.createElement('button');
  confirmButton.className = "watch-btn";
  confirmButton.textContent = "üé¨ –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É";
  confirmButton.style.padding = "10px 20px";
  confirmButton.style.borderRadius = "10px";
  confirmButton.style.background = "#00f7ff";
  confirmButton.style.color = "#000";
  confirmButton.style.fontWeight = "bold";
  confirmButton.style.cursor = "pointer";
  confirmButton.style.boxShadow = "0 0 10px #00f7ff";
  confirmButton.onclick = () => {
    window.Telegram.WebApp.close();
  };

  // –ö–Ω–æ–ø–∫–∞ "–ù—ñ, –∑–∞–ª–∏—à–∏—Ç–∏—Å—å —Ç—É—Ç"
  const cancelButton = document.createElement('button');
  cancelButton.className = "watch-btn";
  cancelButton.textContent = "‚ùå –ó–∞–ª–∏—à–∏—Ç–∏—Å—å —Ç—É—Ç";
  cancelButton.style.padding = "10px 20px";
  cancelButton.style.borderRadius = "10px";
  cancelButton.style.background = "#444";
  cancelButton.style.color = "#fff";
  cancelButton.style.fontWeight = "bold";
  cancelButton.style.cursor = "pointer";
  cancelButton.onclick = () => {
    const overlay = document.getElementById('video-overlay');
    overlay.style.opacity = '0';
    setTimeout(() => {
      overlay.style.display = 'none';
    }, 300);
  };

  buttonsWrapper.appendChild(confirmButton);
  buttonsWrapper.appendChild(cancelButton);

  videoWrapper.appendChild(message);
  videoWrapper.appendChild(buttonsWrapper);

  const overlay = document.getElementById('video-overlay');
  overlay.style.display = 'flex';
  setTimeout(() => {
    overlay.style.opacity = '1';
  }, 50);
}



function confirmOpen() {
  const modal = document.getElementById('confirm-modal');
  modal.classList.remove('show');
  setTimeout(() => {
    try {
      if (window.Telegram?.WebApp?.openLink) {
        window.Telegram.WebApp.openLink(pendingLink);
      } else {
        window.open(pendingLink, '_blank');
      }
    } catch (e) {
      console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –ª—ñ–Ω–∫—É:', e);
      window.open(pendingLink, '_blank');
    } finally {
      pendingLink = "";
      modal.style.display = 'none';   // ‚¨ÖÔ∏è –¥–æ–¥–∞–Ω–æ
    }
  }, 200);
}


function openConfirm(link) {
    pendingLink = link;
    const modal = document.getElementById('confirm-modal');
    modal.style.display = 'flex';
    requestAnimationFrame(() => modal.classList.add('show'));
  }

function cancelOpen() {
    const modal = document.getElementById('confirm-modal');
    modal.classList.remove('show');
    setTimeout(() => { modal.style.display = 'none'; pendingLink = ""; }, 200);
  }

 


function closeVideo() {
  const videoOverlay = document.getElementById('video-overlay');
  const videoWrapper = document.getElementById('video-wrapper');

  videoWrapper.innerHTML = '';
  videoOverlay.style.opacity = '0';
  setTimeout(() => {
    videoOverlay.style.display = 'none';
  }, 400);
}

function showFilmOfTheDay() {
  document.getElementById('film-day-img').classList.remove('skeleton');
  document.getElementById('film-day-img').style.background = 'none';

  const film = films[Math.floor(Math.random() * films.length)];
  document.getElementById('film-day-img').src = film['–§–æ—Ç–æ'];

  document.getElementById('openVideoById').onclick = () => {
    const videoUrl = film['message_id']; // ‚¨ÖÔ∏è —Ç—É—Ç —Ç–µ–ø–µ—Ä '–ü–æ—Å–∏–ª–∞–Ω–Ω—è'
    openVideoById(null, film['–ù–∞–∑–≤–∞']);  // null ‚Äî –±–æ –Ω–µ –∑ —ñ–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏
  };

  document.getElementById('film-title').textContent = maskWord(film['–ù–∞–∑–≤–∞']);

}


    function showSkeletonFilmOfTheDay() {
  document.getElementById('film-day-img').style.background = '#333';
  document.getElementById('film-day-img').classList.add('skeleton');
  document.getElementById('film-title').textContent = '';
}


function showAllFilms() {
  // –ø–µ—Ä–µ–º–∏–∫–∞—î–º–æ—Å—è —É –≤–∫–ª–∞–¥–∫—É ‚Äú–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó‚Äù
  switchTab('categories', document.querySelector('[data-tab=categories]'));
  // –ø–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥–≥—Ä—É–ø—É ‚Äú–§—ñ–ª—å–º–∏ –∑–∞ –∂–∞–Ω—Ä–æ–º‚Äù
  openGenreGroup('films');
}


function showGenres() {
  // —Ç–µ–ø–µ—Ä —Ç—ñ–ª—å–∫–∏ –§—ñ–ª—å–º–∏, –°–µ—Ä—ñ–∞–ª–∏, –ú—É–ª—å—Ç—Ñ—ñ–ª—å–º–∏
  const genres = ['–§—ñ–ª—å–º–∏', '–°–µ—Ä—ñ–∞–ª–∏', '–ú—É–ª—å—Ç—Ñ—ñ–ª—å–º–∏'];
  document.getElementById('genres').innerHTML = genres.map(g => {
    if (g === '–§—ñ–ª—å–º–∏') {
      return `<button class="genre-btn" onclick="showAllFilms()">üéûÔ∏è ${g}</button>`;
    }
    if (g === '–°–µ—Ä—ñ–∞–ª–∏') {
      return `
        <button class="genre-btn"
                onclick="
                  switchTab('categories', document.querySelector('[data-tab=categories]'));
                  openGenreGroup('series');
                  showSeries('–°–µ—Ä—ñ–∞–ª');
                ">
          üì∫ ${g}
        </button>`;
    }
    // –ú—É–ª—å—Ç—Ñ—ñ–ª—å–º–∏
    return `<button class="genre-btn" onclick="goToCartoons()">üëß ${g}</button>`;
  }).join('');
  document.getElementById('genres').style.display = 'flex';
}

// üöÄ –ê–Ω—ñ–º–∞—Ü—ñ—è –º–∏–≥–æ—Ç—ñ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ —É —Ä–æ–∑–¥—ñ–ª—ñ "–§—ñ–ª—å–º–∏ / –°–µ—Ä—ñ–∞–ª–∏ / –ú—É–ª—å—Ç—Ñ—ñ–ª—å–º–∏"
function startBlinkingGenres() {
  const buttons = document.querySelectorAll('#genres .genre-btn');
  if (!buttons.length) return;

  let index = 0;
  setInterval(() => {
    buttons.forEach(btn => btn.classList.remove('blink'));
    buttons[index].classList.add('blink');
    index = (index + 1) % buttons.length;
  }, 1500); // –∫–æ–∂–Ω—ñ 1.5 —Å–µ–∫—É–Ω–¥–∏ –ø–µ—Ä–µ–º–∏–∫–∞—î—Ç—å—Å—è
}

function startBlinkingCategories() {
  const buttons = document.querySelectorAll('#categories .genre-main-btn'); // ‚Üê –±—É–ª–æ .genre-btn
  if (!buttons.length) return;

  let index = 0;
  setInterval(() => {
    buttons.forEach(btn => btn.classList.remove('blink'));
    buttons[index].classList.add('blink');
    index = (index + 1) % buttons.length;
  }, 1500);
}

function startBlinkingCartoons() {
  const buttons = document.querySelectorAll('#group-cartoons .genre-btn'); 
  if (!buttons.length) return;

  let index = 0;
  setInterval(() => {
    buttons.forEach(btn => btn.classList.remove('blink'));
    buttons[index].classList.add('blink');
    index = (index + 1) % buttons.length;
  }, 1500);
}


    function showCountryFilters() {
  const countries = [...new Set(films.map(f => f['–ö—Ä–∞—ó–Ω–∞']).filter(Boolean))];
  const container = document.getElementById('country-filters');
  container.innerHTML = countries.map(country => `
    <button class="genre-btn" onclick="filterByCountry('${country}')">${country}</button>
  `).join('');
  container.style.display = 'flex';
}

function showYearFilters() {
  const years = [...new Set(films.map(f => f['–†—ñ–∫']).filter(Boolean))];
  const container = document.getElementById('year-filters');
  container.innerHTML = years.map(year => `
    <button class="genre-btn" onclick="filterByYear('${year}')">${year}</button>
  `).join('');
  container.style.display = 'flex';
}

    

    function showCollections() {
  const container = document.getElementById('collections');
  const names = [...new Set(films.map(f => f['–î–æ–±—ñ—Ä–∫–∞']).filter(Boolean))];
  container.innerHTML = names.map(name => {
    const img = films.find(f => f['–î–æ–±—ñ—Ä–∫–∞'] === name)?.['–§–æ—Ç–æ'] || '';
    return `
      <div class="collection-card" onclick="filterByGenre('${name}')">
        <img src="${img}" alt="${name}">
        <p>${name}</p>
      </div>
    `;
  }).join('');
  document.getElementById('collections').style.display = 'flex';
}

    
function showSeries(type = '–°–µ—Ä—ñ–∞–ª') {
  const container = document.getElementById('genre-results');
  container.innerHTML = '';

  const types = Array.isArray(type)
    ? type.map(t => (t || '').trim().toLowerCase())
    : [(type || '').trim().toLowerCase()];

  const seriesFilms = films.filter(f =>
    types.includes(((f['–¢–∏–ø'] || '')).trim().toLowerCase()) &&
    (f.message_id || f.file_id) // –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç—ñ —Å–µ—Ä—ñ—ó, –¥–µ —î –≤—ñ–¥–µ–æ
  );

  if (!seriesFilms.length) {
    container.innerHTML = '<p>–ù–µ–º–∞—î —Å–µ—Ä—ñ–∞–ª—ñ–≤ üò¢</p>';
    return;
  }

  const grouped = groupSeriesEpisodes(seriesFilms);
  container.innerHTML = Object.entries(grouped)
    .map(([title, eps]) => renderSeriesCard(title, eps))
    .join('');

  container.scrollIntoView({ behavior: 'smooth' });
}




function filterByGenre(genre) {
  if (!genre) return;
  switchTab('categories');
  const normalized = genre.trim().toLowerCase();
  const container  = document.getElementById('genre-results');

  // 1) –¢–æ—á–Ω–∏–π –∑–±—ñ–≥ –ø–æ –ñ–ê–ù–†–£; —É –î–æ–±—ñ—Ä—Ü—ñ –¥–æ–∑–≤–æ–ª—è—î–º–æ –≤—ñ–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç
  let filtered = films.filter(f => {
    const g1 = f['–ñ–∞–Ω—Ä']    || '';
    const g2 = f['–î–æ–±—ñ—Ä–∫–∞'] || '';
    return hasExactGenre(g1, normalized) || g2.toLowerCase().includes(normalized);
  });

  // 2) –ü—Ä–∏–º—É—Å–æ–≤–æ –ª–∏—à–∞—î–º–æ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –¢–ò–ü –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –≤—ñ–¥–∫—Ä–∏—Ç–æ—ó –ø—ñ–¥–≥—Ä—É–ø–∏
  if (document.getElementById('group-series').style.display === 'flex') {
    filtered = filtered.filter(f => isEpisodicType(f['–¢–∏–ø']));
  } else if (document.getElementById('group-films').style.display === 'flex') {
    filtered = filtered.filter(f => !isEpisodicType(f['–¢–∏–ø']));
  }

  // 3) –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ?
  if (!filtered.length) {
    container.innerHTML = '<p>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üò¢</p>';
    container.scrollIntoView({ behavior: 'smooth' });
    return;
  }


if (isEpisodicType(filtered[0]['–¢–∏–ø'])) {
  const grouped = groupSeriesEpisodes(filtered);
  container.innerHTML = Object.entries(grouped)
    .map(([title, eps]) => renderSeriesCard(title, eps))
    .join('');
  container.scrollIntoView({ behavior: 'smooth' });
  return;
}



  // 5) –Ü–Ω–∞–∫—à–µ ‚Äî –∑–≤–∏—á–∞–π–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Ñ—ñ–ª—å–º—ñ–≤
  currentFilms = filtered;
  container.innerHTML = '';
  offset = 0;
  renderBatch();
  container.scrollIntoView({ behavior: 'smooth' });
}

    
function filterByCountry(country) {
  switchTab('categories');
  const container = document.getElementById('genre-results');
  container.style.display = 'grid';
  container.innerHTML = '';

  currentFilms = films.filter(f => f['–ö—Ä–∞—ó–Ω–∞'] === country);
  if (!currentFilms.length) {
    container.innerHTML = '<p>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üò¢</p>';
    return;
  }
  offset = 0;
  renderBatch();
  container.scrollIntoView({ behavior: 'smooth' });
}


  

function filterByYear(year) {
  switchTab('categories');
  const container = document.getElementById('genre-results');
  const isPro = localStorage.getItem('isProUser') === 'true';
  const filtered = films.filter(f => String(f['–†—ñ–∫']) === String(year));

  if (!filtered.length) {
    container.innerHTML = '<p>–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üò¢</p>';
    return;
  }

  container.innerHTML = filtered.map(film => {
    const id = safeId(film['–ù–∞–∑–≤–∞'], 'country'); // ‚Üê –û–≥–æ–ª–æ—à—É—î–º–æ id!
    const isProFilm = film['–î–æ—Å—Ç—É–ø'] === 'PRO';
    const imgSrc = (isProFilm && !isPro)
      ? placeholderImage
      : (film['–§–æ—Ç–æ'] || placeholderImage);

    let buttons = '';
    if (isProFilm && !isPro) {
      buttons = `<button class="search-button" onclick="alert('üîí –§—ñ–ª—å–º –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –¥–ª—è PRO')">üîí PRO –î–æ—Å—Ç—É–ø</button>`;
    } else if (film['id']) {
      buttons = `<button class="search-button" onclick="requestFilmByName(this, '${film.message_id}', '${film.channel_id}')">‚ñ∂Ô∏è –î–∏–≤–∏—Ç–∏—Å—å</button>`;
    }

    return `
      <div class="film-card" id="film-${id}">
        ${poster(imgSrc, film['–ù–∞–∑–≤–∞'], film['–†—ñ–∫'])}
        <h3>${maskWord(film['–ù–∞–∑–≤–∞'])}</h3>
        <p class="film-imdb">IMDb: ${film['IMDb']||'‚Äî'}</p>
        <p>${film['–û–ø–∏—Å']||''}</p>
        <div class="film-actions">
          ${renderControls(film['–ù–∞–∑–≤–∞'], film['–û–ø–∏—Å'])}
          ${buttons}
        </div>
      </div>
    `;
  }).join('');

  container.scrollIntoView({ behavior: 'smooth' });
}




   function showFavorites() {
  document.querySelectorAll('.film-card').forEach(el => el.remove());

  const container = document.getElementById('fav-list');
  container.innerHTML = '';

  const favs = JSON.parse(localStorage.getItem('favorites') || '[]');

  if (favs.length === 0) {
    container.innerHTML = '<p>–ù–µ–º–∞—î —É–ª—é–±–ª–µ–Ω–∏—Ö</p>';
  } else {
  container.innerHTML = favs.map(f => {
    // –ü–æ—à—É–∫ —Ñ—ñ–ª—å–º—É –≤ –º–∞—Å–∏–≤—ñ films –ø–æ unmaskWord
    const found  = films.find(item =>
      unmaskWord(item['–ù–∞–∑–≤–∞']) === unmaskWord(f.title)
    );
    const msgId = found?.message_id || f.message_id || found?.file_id || f.file_id || '';
    const chId  = found?.channel_id || f.channel_id || '';
    const watchBtn = msgId
      ? `<button class="search-button" onclick="event.stopPropagation(); requestFilmByName(this,'${msgId}','${chId}')">‚ñ∂Ô∏è –î–∏–≤–∏—Ç–∏—Å—å</button>`
      : `<span style="color:#888; display:block; margin-top:8px;">–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>`;
    return `
      <div class="film-card" id="film-${safeId(f.title, 'fav')}">
      <h3>${maskWord(f.title)}</h3>
      <p>${f.description}</p>
      <button class="remove-fav-btn" onclick="removeFromFavorites(${favs.indexOf(f)})">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
      ${watchBtn}
    </div>
  `;
  }).join('');



    
  }

  container.style.display = 'grid';
}

function showProModal() {
  const modal = document.getElementById('pro-modal');
  modal.style.display = 'flex';
  setTimeout(() => modal.style.opacity = '1', 50);
}

function closeProModal() {
  const modal = document.getElementById('pro-modal');
  modal.style.opacity = '0';
  setTimeout(() => modal.style.display = 'none', 300);
}

  
// ‚¨áÔ∏è –°—é–¥–∏ –≤—Å—Ç–∞–≤–ª—è—î—à –Ω–æ–≤—É —Ñ—É–Ω–∫—Ü—ñ—é
function removeFromFavorites(index) {
  const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
  favs.splice(index, 1);
  localStorage.setItem('favorites', JSON.stringify(favs));
  showFavorites(); // –æ–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫
}



    function searchInBot(query) {
      // üßπ –ü–æ–≤–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è –∑–∞–ª–∏—à–∫—ñ–≤
document.getElementById('history-list').innerHTML = '';
document.getElementById('searchResults').innerHTML = '';
document.querySelectorAll('.film-card').forEach(card => card.remove());

  // ‚ùóÔ∏è–°–ø–æ—á–∞—Ç–∫—É —Ö–æ–≤–∞—î–º–æ –≤—Å—ñ —Å–µ–∫—Ü—ñ—ó (–ø—Ä–∏–±–∏—Ä–∞—î –≤—ñ–∑—É–∞–ª—å–Ω–∏–π "–ø–µ—Ä–µ–∫—ñ—Å")
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  // ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—å –Ω–∞ –≥–æ–ª–æ–≤–Ω—É
  document.getElementById('home').classList.add('active');
  document.querySelector('[data-tab=home]')?.classList.add('active');

  if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
    alert("‚õîÔ∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à Telegram ID. –û–Ω–æ–≤—ñ—Ç—å –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫!");
    window.location.reload();
    return;
  }
  const user = tg.initDataUnsafe.user;


  document.getElementById("loading-indicator").style.display = "block";

  // –û—á–∏—â–∞—î–º–æ –ø–æ—à—É–∫
  document.getElementById('searchInput').value = '';
  document.getElementById('searchResults').innerHTML = '';

  fetch('https://relax-time2.onrender.com/search-in-bot', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: user.id, query })
  }).then(r => r.json()).then(d => {
    if (d.found && d.videoUrl) {
      const existing = JSON.parse(localStorage.getItem('history') || '[]');
      if (!existing.find(f => f.title === query)) {
        const film = films.find(f => f['–ù–∞–∑–≤–∞'] === query);
        if (film) {
          existing.unshift({ title: film['–ù–∞–∑–≤–∞'], description: film['–û–ø–∏—Å'] });
          if (existing.length > 20) existing.pop();
          localStorage.setItem('history', JSON.stringify(existing));
        }
      }
      window.location.href = d.videoUrl;
    } else {
      showServiceErrorModal("–§—ñ–ª—å–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üò¢"); // –±–µ–∑ retry ‚Äì –∫–Ω–æ–ø–∫–∞ –Ω–µ –∑'—è–≤–∏—Ç—å—Å—è
    }
  }).catch(err => {
    console.error(err);
    showServiceErrorModal("‚ùóÔ∏è –ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É.<br>–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.", () => searchInBot(query));
  }).finally(() => {
    document.getElementById("loading-indicator").style.display = "none";
  });
  }


    
    function openGenreGroup(group) {
  // ‚ùå –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –í–°–Ü –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
  document.getElementById("group-films").style.display = "none";
  document.getElementById("group-series").style.display = "none";
  document.getElementById("group-cartoons").style.display = "none";

  // ‚ùå –û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–≤—ñ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø–æ—à—É–∫—É —Ñ—ñ–ª—å–º—ñ–≤
  const container = document.getElementById('genre-results');
  if (container) {
    container.innerHTML = '';
  }

  // ‚úÖ –ü–æ–∫–∞–∑–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω—É –≥—Ä—É–ø—É
  const block = document.getElementById("group-" + group);
  if (block) block.style.display = "flex";
}


function switchTab(tabId, btn) {
  document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

  const containersToClear = ['genre-results', 'searchResults', 'fav-list'];
  containersToClear.forEach(id => {
    const el = document.getElementById(id);
    if (el && tabId !== 'categories') {
      el.innerHTML = '';
      // ‚¨ÖÔ∏è –û—Å—å —Ç—É—Ç –≤–∞–∂–ª–∏–≤–æ: —Å—Ö–æ–≤–∞—î–º–æ genre-results
      if (id === 'genre-results') {
        el.style.display = 'none';
      }
    }
  });

  const target = document.getElementById(tabId);
  if (target) target.classList.add('active');
  if (btn) btn.classList.add('active');

  if (tabId === 'favorites') {
    if (!isDataLoaded) {
      alert("‚è≥ –î–∞–Ω—ñ —â–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è. –°–ø—Ä–æ–±—É–π —Ç—Ä–æ—Ö–∏ –ø—ñ–∑–Ω—ñ—à–µ.");
      return;
    }
    showFavorites();
  }

  if (tabId === 'search') {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('searchInput').focus();
    currentFilms = [];
    offset = 0;
  } else if (tabId === 'categories') {
    document.getElementById('genre-results').innerHTML = '';
    document.getElementById('genre-results').style.display = 'grid';
    currentFilms = [];
    offset = 0;
  }

  if (tabId === 'account') {
    if (!isDataLoaded) { alert("‚è≥ –î–∞–Ω—ñ —â–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è. –°–ø—Ä–æ–±—É–π —Ç—Ä–æ—Ö–∏ –ø—ñ–∑–Ω—ñ—à–µ."); return; }
    closeDonatePopup();
    window.scrollTo({ top: 0, behavior: 'smooth' });

    if (typeof window.checkProPendingStatus === 'function') {
      window.checkProPendingStatus();
    }
  }
  }



function showSkeletonCollections() {
  const container = document.getElementById('collections');
  container.innerHTML = `
    <div class="film-card skeleton" style="height:200px; width:130px; border-radius:12px;"></div>
    <div class="film-card skeleton" style="height:200px; width:130px; border-radius:12px;"></div>
    <div class="film-card skeleton" style="height:200px; width:130px; border-radius:12px;"></div>
  `;
}


  document.addEventListener('DOMContentLoaded', async () => {
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑ º—î–¥–Ω–∞–Ω–Ω—è –∑ Telegram –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    if (!window.Telegram.WebApp.initDataUnsafe?.user) {
      document.body.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;">
        <h2 style="color:#00f7ff;">‚õî –í—Ç—Ä–∞—Ç–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ Telegram</h2>
        <p>–û–Ω–æ–≤—ñ—Ç—å –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ –¥–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è</p>
        <button style="padding:12px 30px;border-radius:12px;background:#00f7ff;color:#000;font-weight:bold;font-size:18px;margin-top:15px;" onclick="window.location.reload()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
      </div>
    `;
    }
        
    // –ü—Ä–æ–∫–∏–¥–∞—î–º–æ –±–µ–∫–µ–Ω–¥ Render, —â–æ–± –Ω–µ —Å–ø–∞–≤
  try {
    await fetch('https://relax-time2.onrender.com/ping');
    console.log('‚úÖ –ë–µ–∫–µ–Ω–¥ –ø—Ä–æ–∫–∏–Ω—É–≤—Å—è');
  } catch (e) {
    console.warn('‚ö†Ô∏è –ë–µ–∫–µ–Ω–¥ –Ω–µ –ø—Ä–æ–∫–∏–Ω—É–≤—Å—è:', e);
  }

  
  Telegram.WebApp.ready();
  const user = tg.initDataUnsafe?.user;

  if (!user) {
    alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à Telegram ID");
    return;
  }

  


  try {
    const res = await fetch('https://relax-time2.onrender.com/check-subscription', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: user.id })
    });

 
    const data = await res.json();

   if (!data.subscribed) {
  document.body.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #00f7ff;
      text-align: center;
      padding: 20px;
      font-family: 'Russo One', sans-serif;
    ">
      <h1 style="font-size: 28px; margin-bottom: 20px;">‚ùó –©–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—å –∑–∞—Å—Ç–æ—Å—É–Ω–∫–æ–º</h1>
      <h2 style="font-size: 22px; margin-bottom: 40px;">–ü—ñ–¥–ø–∏—à—ñ—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª üé•</h2>

     <h2 style="font-size: 22px; margin-bottom: 40px;">–ê–∫—Ç–∏–≤—É–π—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É üé¨</h2>

<div style="display: flex; flex-direction: column; gap: 15px;">
  <a href="https://t.me/KinoTochkaUA" target="_blank" style="
    background: #00f7ff;
    color: #000;
    padding: 15px 30px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    text-decoration: none;
    box-shadow: 0 0 15px #00f7ff;
  ">üé¨ –î–æ—Å—Ç—É–ø –¥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É</a>

  <a href="https://t.me/KinoTochkaFilms" target="_blank" style="
    background: #00f7ff;
    color: #000;
    padding: 15px 30px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    text-decoration: none;
    box-shadow: 0 0 15px #00f7ff;
  ">üé¨ –î–æ—Å—Ç—É–ø –¥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É</a>
</div>

      <p style="margin-top: 40px; font-size: 16px; color: #ccc;">–ü—ñ—Å–ª—è –ø—ñ–¥–ø–∏—Å–∫–∏ –æ–Ω–æ–≤—ñ—Ç—å –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫ üì≤</p>
    </div>
  `;
  return;
}

  // ‚úÖ –¢—É—Ç –≤—Å—Ç–∞–≤–ª—è—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É PRO
const proRes = await fetch('https://relax-time2.onrender.com/check-pro', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ user_id: user.id })
});
const proData = await proRes.json();

if (proData.isPro) {
  localStorage.setItem('isProUser', 'true');
  localStorage.removeItem('paymentPending');
  localStorage.removeItem('invoice_id');
  document.getElementById("confirmPaidBtn").style.display = "none";
} else {
  localStorage.removeItem('isProUser');

  // ‚úÖ –≤—Ä–∞—Ö–æ–≤—É—î–º–æ —ñ paymentPending, —ñ invoice_id
  const hasPending =
    localStorage.getItem('paymentPending') === 'true' ||
    !!localStorage.getItem('invoice_id');

  if (hasPending) {
    showConfirmPaidButton(user);
    startProPolling();
  } else {
    document.getElementById("confirmPaidBtn").style.display = "none";
  }
}




try {
  const getProBtn = document.getElementById('getProBtn');
  if (proData?.isPro && proData.expire_date) {
    // —è–∫—â–æ –∫–Ω–æ–ø–∫–∞ —î ‚Äì —Ö–æ–≤–∞—î–º–æ
    if (getProBtn) {
      getProBtn.style.display = 'none';
      const proNotice = document.createElement('p');
      proNotice.textContent = `‚úÖ –í–∞—à PRO –∞–∫—Ç–∏–≤–Ω–∏–π –¥–æ ${proData.expire_date}`;
      proNotice.style.color = "#00f7ff";
      proNotice.style.marginTop = "15px";
      getProBtn.parentNode.insertBefore(proNotice, getProBtn.nextSibling);
    }
  }
} catch (err) {
  console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–≤–µ–¥–µ–Ω–Ω—ñ PRO-—Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è:', err);
}



  fetch('https://relax-time2.onrender.com/reactivate-user', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: user.id })
  }).catch(console.warn);

} catch (error) {
  console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø—ñ–¥–ø–∏—Å–∫–∏', error);
  showRetryOverlay();
  return;
}

  // üü¢ –Ø–∫—â–æ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π, —Ç—ñ–ª—å–∫–∏ —Ç–æ–¥—ñ –≤—Å–µ —ñ–Ω—à–µ:
  



  // –ü–æ–∫–∞–∑–∞—Ç–∏ —Å–∫–µ–ª–µ—Ç–æ–Ω–∏
  showSkeletonCollections();
  showSkeletonFilmOfTheDay();

  // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ—ñ–ª—å–º–∏ —ñ —Ñ–∞–∫—Ç–∏
  await loadFilms();

  // --- Lazy load observer ---
const sentinel = document.getElementById('list-end-sentinel');
const observer = new IntersectionObserver(entries => {
  if (entries[0].isIntersecting && offset < currentFilms.length) {
    renderBatch();
    
  }
}, {
  rootMargin: '200px'

});
observer.observe(sentinel);


  

    // –Ø–∫—â–æ —á–µ—Ä–µ–∑ 6 —Å–µ–∫—É–Ω–¥ —Ñ—ñ–ª—å–º–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—å ‚Äî –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
  setTimeout(() => {
    if (!films.length) {
      alert("‚ö†Ô∏è –ú–æ–∂–ª–∏–≤–æ, —Å–ª–∞–±–∫–∏–π —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑ –∞–±–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫.");
    }
  }, 6000);

 

  // –ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏ –∫—Ä–∞—ó–Ω —ñ —Ä–æ–∫—ñ–≤
  showCountryFilters();
  showYearFilters();

  // –¢–µ–º–Ω–∞ —Ç–µ–º–∞
  const toggle = document.getElementById('theme-toggle');
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'light') {
    document.body.classList.add('light-theme');
    toggle.checked = true;
  }
  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.body.classList.add('light-theme');
      localStorage.setItem('theme', 'light');
    } else {
      document.body.classList.remove('light-theme');
      localStorage.setItem('theme', 'dark');
    }
  });

  // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–æ–≥–æ—Ä–∏
  const scrollTopBtn = document.getElementById('scrollTopBtn');
  if (scrollTopBtn) {
    scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        scrollTopBtn.classList.add('show');
      } else {
        scrollTopBtn.classList.remove('show');
      }
    });
  }

  // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.getAttribute('data-tab');
      switchTab(tab, btn);
    });
  });

  // –û–±—Ä–æ–±–Ω–∏–∫–∏ –∂–∞–Ω—Ä—ñ–≤
document.querySelectorAll('.genre-btn[data-genre]').forEach(button => {
  button.addEventListener('click', () => {
    const genre = button.getAttribute('data-genre');
    if (!genre) return;
    filterByGenre(genre);
  });
});

// –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ—à—É–∫—É
// –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ—à—É–∫—É
// –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ—à—É–∫—É
document.getElementById('searchInput').addEventListener('input', () => {
  const val = unmaskWord(document.getElementById('searchInput').value).trim().toLowerCase();
  const container = document.getElementById('searchResults');
  container.innerHTML = '';
  if (!val) return;

  // 1) –ó–±—ñ–≥–∏ –ø–æ –Ω–∞–∑–≤—ñ (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º mask/unmask)
  const hits = films.filter(f =>
    unmaskWord(f['–ù–∞–∑–≤–∞'] || '').toLowerCase().includes(val)
  );

  // 2) –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ
  if (hits.length === 0) {
    container.innerHTML = `
      <p>–§—ñ–ª—å–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üò¢</p>
      <button class="suggest-button" onclick="suggestFilm()">‚ûï –ó–∞–º–æ–≤–∏—Ç–∏ —Ü–µ–π —Ñ—ñ–ª—å–º</button>
    `;
    return;
  }

  // 3) –Ø–∫—â–æ —Å–µ—Ä–µ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —î —Å–µ—Ä—ñ–∞–ª–∏ ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ —ó—Ö –∑–≥—Ä—É–ø–æ–≤–∞–Ω–æ —ñ –í–ò–•–û–î–ò–ú–û
  const seriesHits = hits.filter(f => isEpisodicType(f['–¢–∏–ø']));
if (seriesHits.length > 0) {
  const groupedSeries = groupSeriesEpisodes(seriesHits);
  container.innerHTML = Object.entries(groupedSeries)
    .map(([title, episodes]) => renderSeriesCard(title, episodes))
    .join('');
  container.scrollIntoView({ behavior: 'smooth' }); // (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)
  return;
}



  // 4) –Ü–Ω–∞–∫—à–µ ‚Äî –∑–≤–∏—á–∞–π–Ω—ñ —Ñ—ñ–ª—å–º–∏, –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏ –∑–∞ –Ω–∞–∑–≤–æ—é
  const unique = [];
  const seen = new Set();
  for (const f of hits) {
    if (!seen.has(f['–ù–∞–∑–≤–∞'])) { seen.add(f['–ù–∞–∑–≤–∞']); unique.push(f); }
  }

  const isPro = localStorage.getItem('isProUser') === 'true';
  container.innerHTML = unique.map(f => {
    const id = safeId(f['–ù–∞–∑–≤–∞'], 'search');
    const locked = f['–î–æ—Å—Ç—É–ø'] === 'PRO' && !isPro;
    const img = locked ? placeholderImage : (f['–§–æ—Ç–æ'] || placeholderImage);
    const mid = (f['message_id'] || f['file_id']);
    const ch  = (f['channel_id'] || '');
    const watchBtn = locked
      ? `<button class="search-button" onclick="showProModal()">üîí PRO</button>`
      : (mid
         ? `<button class="search-button" onclick="requestFilmByName(this,'${mid}','${ch}')">‚ñ∂Ô∏è –î–∏–≤–∏—Ç–∏—Å—å</button>`
         : `<button class="search-button" onclick="openVideoById(this,'${f['–ù–∞–∑–≤–∞']}')">‚ñ∂Ô∏è –î–∏–≤–∏—Ç–∏—Å—å</button>`);

    return `
      <div class="film-card" id="film-${id}">
        ${poster(img, f['–ù–∞–∑–≤–∞'], f['–†—ñ–∫'])}
        <h3>${maskWord(f['–ù–∞–∑–≤–∞'])}</h3>
        <p class="film-imdb">IMDb: ${f['IMDb'] || '‚Äî'}</p>
        <p>${f['–û–ø–∏—Å'] || ''}</p>
        <div class="film-actions">
          ${renderControls(f['–ù–∞–∑–≤–∞'], f['–û–ø–∏—Å'])}
          ${watchBtn}
        </div>
      </div>
    `;
  }).join('');
});


 




  // –ö–ª—ñ–∫ –ø–æ –∫–∞—Ä—Ç—Ü—ñ
  document.addEventListener('click', (e) => {
    const card = e.target.closest('.film-card');
    if (card && !e.target.closest('button')) {
      card.classList.toggle('expanded');
    }
  });




function addToFavorites(title, description, message_id) {
  const film = films.find(f => unmaskWord(f['–ù–∞–∑–≤–∞']) === unmaskWord(title));
  const real_message_id = film?.message_id || film?.file_id || message_id || '';
  const real_channel_id = film?.channel_id || '';

  const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
  if (favs.find(f => f.title === title)) {
    showServiceErrorModal('–í–∂–µ –≤ —É–ª—é–±–ª–µ–Ω–æ–º—É üíõ');
    return;
  }
  favs.push({ title, description, message_id: real_message_id, channel_id: real_channel_id });
  localStorage.setItem('favorites', JSON.stringify(favs));
  showFavorites();
  alert('–î–æ–¥–∞–Ω–æ –≤ —É–ª—é–±–ª–µ–Ω–µ!');
}


window.addToFavorites = addToFavorites;



     let isSending = false;
async function requestWithRetry(url, options, retries = 3, delay = 1000) {
  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch(url, options);
      if (res.ok) return res;
    } catch (e) {
      console.warn(`‚ö†Ô∏è –°–ø—Ä–æ–±–∞ ${i + 1} –Ω–µ –≤–¥–∞–ª–∞—Å—è`);
    }
    await new Promise(resolve => setTimeout(resolve, delay));
  }
  throw new Error("‚ùå –£—Å—ñ —Å–ø—Ä–æ–±–∏ –∑–∞–ø–∏—Ç—É –Ω–µ –≤–¥–∞–ª–∏—Å—è");
}


function rateFilm(filmName, action) {
  const key = `rating-${safeId(filmName, 'rating')}`;
  const previousAction = localStorage.getItem(key);

  // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ —Ç—É –∂ —Å–∞–º—É –∫–Ω–æ–ø–∫—É ‚Äî –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ
  if (previousAction === action) return;
  localStorage.setItem(key, action);

  // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ –±–µ–∫–µ–Ω–¥
  fetch('https://relax-time2.onrender.com/rate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      film_name: filmName,
      action: action,
      undo: previousAction
    }),
  });

  // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏-–ª—ñ—á–∏–ª—å–Ω–∏–∫–∏
  const likeBtnCount    = document.getElementById(`like-count-btn-${safeId(filmName, 'rating')}`);
  const dislikeBtnCount = document.getElementById(`dislike-count-btn-${safeId(filmName, 'rating')}`);
  const likeDisplay     = document.getElementById(`like-count-${safeId(filmName, 'rating')}`);
  const dislikeDisplay  = document.getElementById(`dislike-count-${safeId(filmName, 'rating')}`);

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∏—Å–ª–∞
  function upd(el, delta) {
    if (!el) return;
    el.textContent = Math.max(0, Number(el.textContent || 0) + delta);
  }

  // –Ü–Ω–∫—Ä–µ–º–µ–Ω—Ç/–¥–µ–∫—Ä–µ–º–µ–Ω—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –¥—ñ—ó
  if (action === 'like') {
    upd(likeBtnCount,    +1);
    upd(likeDisplay,     +1);
    if (previousAction === 'dislike') {
      upd(dislikeBtnCount, -1);
      upd(dislikeDisplay,  -1);
    }
  } else {
    upd(dislikeBtnCount, +1);
    upd(dislikeDisplay,  +1);
    if (previousAction === 'like') {
      upd(likeBtnCount,   -1);
      upd(likeDisplay,    -1);
    }
  }

  // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –∫–Ω–æ–ø–∫—É
  const card       = likeBtnCount.closest('.film-card');
  const likeBtn    = card.querySelector('.rating-button:nth-of-type(1)');
  const dislikeBtn = card.querySelector('.rating-button:nth-of-type(2)');
  likeBtn.classList.remove('active-like');
  dislikeBtn.classList.remove('active-dislike');
  if (action === 'like')    likeBtn.classList.add('active-like');
  if (action === 'dislike') dislikeBtn.classList.add('active-dislike');
}



async function suggestFilm() {
  const inputEl = document.getElementById('searchInput');
  const val = (inputEl?.value || '').trim(); // —è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—à maskWord ‚Äî –º–æ–∂–µ—à —Ç—É—Ç —Ä–æ–±–∏—Ç–∏ unmaskWord(val)
  if (!val || isSending) return;

  const tg = window.Telegram?.WebApp;
  const userId = tg?.initDataUnsafe?.user?.id;
  if (!userId) {
    alert("‚õîÔ∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à Telegram ID. –û–Ω–æ–≤—ñ—Ç—å –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫!");
    window.location.reload();
    return;
  }

  isSending = true;

  // —Ç–∏–º—á–∞—Å–æ–≤–æ –±–ª–æ–∫—É—î–º–æ –∫–Ω–æ–ø–∫—É, —â–æ–± –Ω–µ —Å–ø–∞–º–∏—Ç–∏ –∑–∞–ø–∏—Ç–∞–º–∏
  const btn = document.querySelector(".suggest-button");
  if (btn) {
    btn.disabled = true;
    setTimeout(() => (btn.disabled = false), 7000);
  }

  // –ø–æ–∫–∞–∑–∞—Ç–∏ –æ–≤–µ—Ä–ª–µ–π, —è–∫—â–æ –≤—ñ–Ω —ñ—Å–Ω—É—î –≤ DOM
  const overlay = document.getElementById('request-loading');
  if (overlay) overlay.style.display = 'flex';

  try {
    // ‚Äú—Ä–æ–∑–±—É–¥–∏—Ç–∏‚Äù –±–µ–∫–µ–Ω–¥ + –Ω–µ–≤–µ–ª–∏–∫–∞ –ø–∞—É–∑–∞
    try { await fetch('https://relax-time2.onrender.com/ping'); } catch {}
    await new Promise(r => setTimeout(r, 800));

    // –æ—Å–Ω–æ–≤–Ω–∏–π –∑–∞–ø–∏—Ç –∑ —Ä–µ—Ç—Ä–∞—è–º–∏
    const res = await requestWithRetry('https://relax-time2.onrender.com/request-film', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, film_name: val })
    });

    // –Ω–∞–º–∞–≥–∞—î–º–æ—Å—è –∑—á–∏—Ç–∞—Ç–∏ JSON; —è–∫—â–æ –Ω–µ JSON ‚Äî –≤–≤–∞–∂–∞—î–º–æ –ø–æ–º–∏–ª–∫–æ—é
    let data = null;
    try { data = await res.clone().json(); } catch {}

    if (data) {
      showSuggestResult({
        success: res.ok && data.ok !== false,
        remaining_requests: data.remaining_requests ?? '‚àû',
        is_pro: !!data.is_pro
      });
    } else {
      showSuggestResult({ success: false, remaining_requests: 0, is_pro: false });
    }
  } catch (error) {
    console.error(error);
    showSuggestResult({ success: false, remaining_requests: 0, is_pro: false });
  } finally {
    isSending = false;
    if (overlay) overlay.style.display = 'none';
  }
}

  

    function toggleHistory() {
  const container = document.getElementById('history-list');
  if (container.style.display === 'block') {
    container.style.display = 'none';
  } else {
    showHistory();
  }
}



// ‚úÖ –í–ò–ù–ï–°–ò –æ–∫—Ä–µ–º–æ —Ñ—É–Ω–∫—Ü—ñ—é rate() –ø—ñ—Å–ª—è showHistory
function rate(title, stars) {
  localStorage.setItem(`rating_${title}`, stars);
  showHistory();
}


function clearHistory() {
  localStorage.removeItem('history');
  showHistory(); // –æ–¥—Ä–∞–∑—É –æ–Ω–æ–≤–ª—é—î –≤–∏–≤—ñ–¥
}
      
 

   function goToCartoons() {
  switchTab('categories', document.querySelector('[data-tab=categories]'));
  openGenreGroup('cartoons');

  // –î–æ–¥–∞—î–º–æ –ø–ª–∞–≤–Ω—É –ø—Ä–æ–∫—Ä—É—Ç–∫—É —á–µ—Ä–µ–∑ 300 –º—Å, –∫–æ–ª–∏ –≤—Å–µ –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è
  setTimeout(() => {
    const target = document.getElementById('group-cartoons');
    if (target) {
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, 300);
}

function closeDonatePopup() {
  const popup = document.getElementById('donate-popup');
  if (popup) {
    popup.style.opacity = '0';
    setTimeout(() => {
      popup.style.display = 'none';
    }, 300);
  }
}
// ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Å—Ç–∞–±—ñ–ª—å–Ω–µ –≤—ñ–∫–æ–Ω—Ü–µ –¥–æ–Ω–∞—Ç—É —á–µ—Ä–µ–∑ 20 —Å–µ–∫—É–Ω–¥
setTimeout(() => {
  const popup = document.getElementById('donate-popup');
  if (popup) {
    popup.style.display = 'block';
    popup.style.opacity = '0';
    popup.style.transition = 'opacity 0.5s ease';
    setTimeout(() => popup.style.opacity = '1', 10);
  }
}, 20000);


function goToSeries(seriesTitle) {
  switchTab('categories', document.querySelector('[data-tab=categories]'));
  openGenreGroup('series');

  setTimeout(() => {
    const filtered = films.filter(f => f['–ù–∞–∑–≤–∞'] === seriesTitle && isEpisodicType(f['–¢–∏–ø']));
    if (!filtered.length) { alert('–°–µ—Ä—ñ–∞–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ üò¢'); return; }
    const container = document.getElementById('genre-results');
    container.innerHTML = renderSeriesCard(seriesTitle, filtered);
    container.scrollIntoView({ behavior: 'smooth' });
  }, 300);
}





function showConfirmPaidButton(user) {
  const btn = document.getElementById("confirmPaidBtn");
  btn.style.display = "block";
  closeDonatePopup();

  const newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);

  newBtn.onclick = () => {
    // 1) –ø–æ–∑–Ω–∞—á–∞—î–º–æ, —â–æ —é–∑–µ—Ä –Ω–∞—Ç–∏—Å–Ω—É–≤ ‚Äú–Ø –æ–ø–ª–∞—Ç–∏–≤‚Äù
    localStorage.setItem("paymentPending", "true");
    // 2) –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–∞–ø–∏—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
    notifyPayment(user.id, user.username || "", user.first_name || "");
    // 3) —Ö–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫—É –¥–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    newBtn.style.display = "none";
  };
}




let isPaymentSending = false;

async function notifyPayment(userId, username, firstName) {
  // –ü–æ–∫–∞–∑—É—î–º–æ loader
  document.getElementById("payment-loading").style.display = "flex";
  try {
    const res = await fetch('https://relax-time2.onrender.com/notify-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        user_id: userId,
        username: username,
        first_name: firstName
      })
    });
    const data = await res.json();

    if (data.ok) {
      localStorage.removeItem("paymentPending");
      document.getElementById("confirmPaidBtn").style.display = "none";
      showPaymentResult(true);
    } else {
      showPaymentResult(false);
      document.getElementById("confirmPaidBtn").style.display = "block";
    }
  } catch (e) {
    console.error(e);
    showPaymentResult(false);
    document.getElementById("confirmPaidBtn").style.display = "block";
  } finally {
    // –•–æ–≤–∞—î–º–æ loader —É –±—É–¥—å-—è–∫–æ–º—É –≤–∏–ø–∞–¥–∫—É
    document.getElementById("payment-loading").style.display = "none";
  }
}



function showPaymentResult(success) {
  if (success) {
    localStorage.removeItem('paymentPending');
    alert('‚úÖ –û–ø–ª–∞—Ç—É –æ—Ç—Ä–∏–º–∞–Ω–æ. –ß–µ–∫–∞–π—Ç–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è PRO-–¥–æ—Å—Ç—É–ø—É.');
  } else {
    alert(
      '‚ùå –°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—ñ –æ–ø–ª–∞—Ç–∏.\n\n' +
      'üîÑ –ó–∞—á–µ–∫–∞–π—Ç–µ 10-15 —Å–µ–∫ —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–Ø –æ–ø–ª–∞—Ç–∏–≤" —â–µ —Ä–∞–∑.\n' +
      '–Ø–∫—â–æ –≤—Å–µ –æ–¥–Ω–æ –Ω–µ –ø—Ä–∞—Ü—é—î ‚Äî –Ω–∞–ø–∏—à—ñ—Ç—å –∞–¥–º—ñ–Ω—É –≤ –±–æ—Ç.'
    );
  }
}




function showProPrompt() {
  const overlay = document.getElementById('video-overlay');
  const wrapper = document.getElementById('video-wrapper');

  wrapper.innerHTML = `
    <h3 style="color:#00f7ff;">üîí –§—ñ–ª—å–º –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –¥–ª—è PRO</h3>
    <p style="margin:15px 0;">–ê–∫—Ç–∏–≤—É–π PRO, —â–æ–± –¥–∏–≤–∏—Ç–∏—Å—å —É—Å—ñ —Ñ—ñ–ª—å–º–∏ –±–µ–∑ –æ–±–º–µ–∂–µ–Ω—å.</p>
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button class="watch-btn" onclick="goToPro()">üöÄ –ü–µ—Ä–µ–π—Ç–∏ –¥–æ PRO</button>
      <button class="watch-btn" onclick="closeVideo()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
  `;

  overlay.style.display = 'flex';
  setTimeout(() => overlay.style.opacity = '1', 50);
}

function goToPro() {
  const overlay = document.getElementById('video-overlay');
  const wrapper = document.getElementById('video-wrapper');

  wrapper.innerHTML = '';
  overlay.style.opacity = '0';

  setTimeout(() => {
    overlay.style.display = 'none';
    switchTab('account', document.querySelector('[data-tab=account]'));

    // –û–¥—Ä–∞–∑—É —ñ–º—ñ—Ç—É—î–º–æ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ "–û—Ç—Ä–∏–º–∞—Ç–∏ PRO"
    const getProBtn = document.getElementById('getProBtn');
    if (getProBtn) getProBtn.click();
  }, 300);
}

    
function sendFilm(film_id) {
  if (!isDataLoaded) {
    alert("‚è≥ –î–∞–Ω—ñ —â–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è, –∑–∞—á–µ–∫–∞–π—Ç–µ...");
    return;
  }

  const film = films.find(f => f.message_id === film_id || f.file_id === film_id);
  if (!film) {
    alert("‚ùå –§—ñ–ª—å–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, —Å–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.");
    return;
  }

  const tg = window.Telegram?.WebApp;
  const user = tg?.initDataUnsafe?.user;
  if (!user) {
    alert("‚õîÔ∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à Telegram ID. –û–Ω–æ–≤—ñ—Ç—å –∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫!");
    location.reload();
    return;
  }

  fetch('https://relax-time2.onrender.com/send-film-id', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      user_id: user.id,
      message_id: film_id,
      channel_id: film?.channel_id || ''
    })
  })
  .then(r => r.json())
  .then(res => {
    if (res.success) {
      console.log("‚úÖ –§—ñ–ª—å–º –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ");
    } else {
      alert(`‚ùå ${res.error || '–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.'}`);
    }
  })
  .catch(err => {
    console.error(err);
    showServiceErrorModal("‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ, —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Ö–≤–∏–ª–∏–Ω—É.");
  });
}



function toggleEpisodes(id, btn){
  const wrap = document.getElementById(`seasonswrap-${id}`); // –∫–æ–ª–∏ –±–∞–≥–∞—Ç–æ —Å–µ–∑–æ–Ω—ñ–≤
  const grid = document.getElementById(`episodes-${id}`);    // –∫–æ–ª–∏ —Å–µ–∑–æ–Ω –æ–¥–∏–Ω
  const target = wrap || grid;
  if (!target) return;

  const displayType = wrap ? 'block' : 'grid';
  const isHidden = getComputedStyle(target).display === 'none';
  target.style.display = isHidden ? displayType : 'none';

  if (isHidden){
    btn.textContent = 'üîΩ –°—Ö–æ–≤–∞—Ç–∏';
  } else {
    const total = target.dataset.count || btn.dataset.count || '';
    btn.textContent = grid
      ? `üì∫ –ü–æ–∫–∞–∑–∞—Ç–∏ —Å–µ—Ä—ñ—ó (${total})`
      : `üìö –ü–æ–∫–∞–∑–∞—Ç–∏ —Å–µ–∑–æ–Ω–∏ (${total})`;
  }
}



  // –†–æ–±–∏–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó –≥–ª–æ–±–∞–ª—å–Ω–∏–º–∏ –¥–ª—è inline onClick
  window.toggleEpisodes   = toggleEpisodes;
  window.closeDonatePopup = closeDonatePopup;
  window.openConfirm      = openConfirm;
  window.confirmOpen      = confirmOpen;
  window.cancelOpen       = cancelOpen;
  window.suggestFilm      = suggestFilm;


  window.openVideoById       = openVideoById;
  window.requestFilmByName   = requestFilmByName;
  window.showProModal        = showProModal;
  window.closeProModal       = closeProModal;
  window.goToPro             = goToPro;
  window.closeVideo          = closeVideo;
  window.openGenreGroup      = openGenreGroup;
  window.switchTab           = switchTab;
  window.goToCartoons = goToCartoons; // –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ú—É–ª—å—Ç—Ñ—ñ–ª—å–º–∏" –Ω–∞ –ì–æ–ª–æ–≤–Ω—ñ–π
  window.showAllFilms = showAllFilms; // –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–§—ñ–ª—å–º–∏" –Ω–∞ –ì–æ–ª–æ–≤–Ω—ñ–π
  window.showSeries   = showSeries;   // –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–µ—Ä—ñ–∞–ª–∏" –Ω–∞ –ì–æ–ª–æ–≤–Ω—ñ–π
  window.toggleSeason = toggleSeason;
    
// –ó–∞–ø—É—Å–∫ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ PRO-—Å—Ç–∞—Ç—É—Å—É
function startProPolling() {
  if (proPollInterval) return;
  proPollInterval = setInterval(async () => {
    try {
      const res = await fetch('https://relax-time2.onrender.com/check-pro', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ user_id: window.Telegram.WebApp.initDataUnsafe.user.id })
      });
      const data = await res.json();
      if (data.isPro) {
        clearInterval(proPollInterval);
        proPollInterval = null;
        localStorage.removeItem("paymentPending");
        localStorage.setItem("isProUser", "true");
        updateUIAfterPro(data.expire_date);
      }
    } catch (e) { console.warn(e); }
  }, 5000); // –∫–æ–∂–Ω—ñ 5 —Å–µ–∫—É–Ω–¥
}

// –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –æ–ø–ª–∞—Ç–∏
function updateUIAfterPro(expireDate) {
  const btn = document.getElementById("confirmPaidBtn");
  if (btn) btn.style.display = "none";
  const notice = document.createElement("p");
  notice.textContent = `‚úÖ –í–∞—à PRO –∞–∫—Ç–∏–≤–Ω–∏–π –¥–æ ${expireDate}`;
  notice.style.color = "#00f7ff";
  document.getElementById("getProBtn").after(notice);
}
// –î–æ–¥–∞–π —Ü—é —Ñ—É–Ω–∫—Ü—ñ—é –≤ –∫—ñ–Ω–µ—Ü—å —Å–≤–æ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ <script> –±–ª–æ–∫—É (–∞–±–æ —Ç—É–¥–∏, –¥–µ —ñ–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó)
window.checkProPendingStatus = async function checkProPendingStatus() {

  const user = tg.initDataUnsafe?.user;
  if (!user) return;

  // 1. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Å—Ç–∞—Ç—É—Å PRO
  try {
    const proRes = await fetch('https://relax-time2.onrender.com/check-pro', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: user.id })
    });
    const proData = await proRes.json();

if (proData.isPro) {
  // ‚úÖ PRO –∞–∫—Ç–∏–≤–Ω–∏–π ‚Äî —Ö–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫—É —ñ –æ—á–∏—â–∞—î–º–æ –ª–æ–∫–∞–ª—å–Ω—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ
  localStorage.setItem('isProUser', 'true');
  localStorage.removeItem('paymentPending');
  localStorage.removeItem('invoice_id');
  document.getElementById("confirmPaidBtn").style.display = "none";
} else {
  localStorage.removeItem('isProUser');

  // ‚úÖ –≤—Ä–∞—Ö–æ–≤—É—î–º–æ —ñ paymentPending, —ñ invoice_id
  const hasPending =
    localStorage.getItem('paymentPending') === 'true' ||
    !!localStorage.getItem('invoice_id');

  if (hasPending) {
    showConfirmPaidButton(user);
    startProPolling();
  } else {
    document.getElementById("confirmPaidBtn").style.display = "none";
  }
}

  } catch (e) {
    // –Ø–∫—â–æ –±—É–ª–∞ –ø–æ–º–∏–ª–∫–∞ ‚Äî –∑–∞–ª–∏—à–∞—î–º–æ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä—É!
    if (localStorage.getItem('paymentPending') === 'true') {
      showConfirmPaidButton(user);
    }
    console.warn('–ü—Ä–æ–±–ª–µ–º–∞ –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é PRO:', e);
  }
}

// –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ–≤–µ—Ä–Ω—É–≤—Å—è —É WebApp, –∞–ª–µ –¥–∞–Ω–∏—Ö –Ω–µ–º–∞ ‚Äî –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É
document.addEventListener("visibilitychange", function() {
  if (!document.hidden && !window.Telegram.WebApp.initDataUnsafe?.user) {
    window.location.reload();
  }
});

function showRetryOverlay() {
  const overlay = document.getElementById('error-overlay');
  overlay.style.display = 'flex';
  // –∫–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω–µ ¬´–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏¬ª ‚Äî –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É
  document.getElementById('reload-btn').onclick = () => {
    window.location.reload();
  };
}

document.getElementById('contact-admin-btn').onclick = function() {
  document.getElementById('admin-message-modal').style.display = 'block';
};

document.getElementById('close-admin-modal-btn').onclick = function() {
  document.getElementById('admin-message-modal').style.display = 'none';
};

document.getElementById('send-admin-message-btn').onclick = async function() {
  const text = document.getElementById('admin-message-text').value.trim();
  if (!text) {
    alert("–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!");
    return;
  }

  const tg = window.Telegram?.WebApp;
  const user_id = tg?.initDataUnsafe?.user?.id;

  if (!user_id) {
    alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.");
    return;
  }

  // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ –±–µ–∫–µ–Ω–¥
  try {
    const resp = await fetch('https://relax-time2.onrender.com/contact-admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id, text })
    });
    const res = await resp.json();
    if (res.ok) {
      alert('–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∞–¥–º—ñ–Ω—É!');
      document.getElementById('admin-message-modal').style.display = 'none';
      document.getElementById('admin-message-text').value = '';
    } else {
      alert('–°—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
  } catch(e) {
    alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
  }
};
});

</script>

<button id="scrollTopBtn" class="scroll-top-btn">üîù</button>

<div id="video-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10050; justify-content:center; align-items:center; transition: opacity 0.4s ease;">
  <div id="video-wrapper" style="background:#000; padding:20px; border-radius:12px; max-width:800px; width:90%; text-align:center; box-shadow: 0 0 20px rgba(0, 247, 255, 0.3);">
    <!-- –¢—É—Ç JS –≤—Å—Ç–∞–≤–ª—è—Ç–∏–º–µ –∞–±–æ loader, –∞–±–æ –≤—ñ–¥–µ–æ —á–µ—Ä–µ–∑ innerHTML -->
  </div>
</div>

<div id="confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#1a1a1a; padding:20px; border-radius:12px; max-width:300px; text-align:center; box-shadow:0 0 20px #00f7ff;">
    <p style="color:#00f7ff; font-size:18px; margin-bottom:20px;">üé¨ –ë–∞–∂–∞—î—Ç–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ—ñ–ª—å–º?</p>
    <div style="display:flex; gap:10px; justify-content:center;">
      <button onclick="confirmOpen()" style="padding:8px 16px; background:#00f7ff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">–¢–∞–∫</button>
      <button onclick="cancelOpen()" style="padding:8px 16px; background:#444; border:none; border-radius:8px; cursor:pointer; color:#fff;">–ù—ñ</button>
    </div>
  </div>
</div>

<div id="donate-popup" style="display:none; position:fixed; bottom:120px; left:50%; transform:translateX(-50%); z-index:9999;">

  
  <button onclick="closeDonatePopup()" style="
    position:absolute; top:6px; right:10px; background:none; 
    border:none; color:#fff; font-size:20px; cursor:pointer;">‚úñÔ∏è</button>

  <p style="margin-bottom:10px; font-size:16px;">
    <span style="color:#00f7ff;">–¢–≤—ñ–π –¥–æ–Ω–∞—Ç</span> = 
    <span style="color:#ffcc00;">–Ω–∞—à–∞ –º–æ—Ç–∏–≤–∞—Ü—ñ—è</span> –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —â–µ –∫—Ä–∞—â–µ üí™
  </p>

  <a href="https://send.monobank.ua/jar/8G3rv7edqZ" target="_blank" style="
    padding:12px 24px; background:#00f7ff; color:#000; font-weight:bold;
    text-decoration:none; border-radius:10px; display:inline-block;
    box-shadow:0 0 15px #00f7ff; font-size:16px;
  ">‚òï –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ RelaxTime</a>
</div>




<footer style="text-align:center; font-size:12px; color:#666; padding:15px 10px; line-height:1.4;">
  ‚ö†Ô∏è –í–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç –ª–∏—à–µ –¥–ª—è –æ–∑–Ω–∞–π–æ–º–ª–µ–Ω–Ω—è. –Ø–∫—â–æ –º–∏ –ø–æ—Ä—É—à–∏–ª–∏ –≤–∞—à—ñ –∞–≤—Ç–æ—Ä—Å—å–∫—ñ –ø—Ä–∞–≤–∞ ‚Äî –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—å: 
  <a href="mailto:relax-time-bot@ukr.net" style="color:#00f7ff; text-decoration:underline;">relax-time-bot@ukr.net</a><br>
  ‚ö†Ô∏è All content is for informational purposes only. If we violated your copyright, contact us.
</footer>

<div id="pro-modal" style="
  display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
  background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
  
  <div style="background:#1a1a1a; padding:20px; border-radius:12px; max-width:300px; text-align:center; box-shadow:0 0 20px #00f7ff;">
    <p style="color:#00f7ff; font-size:18px; margin-bottom:20px;">üîí –§—ñ–ª—å–º –¥–æ—Å—Ç—É–ø–Ω–∏–π –ª–∏—à–µ –¥–ª—è PRO</p>
    <p style="margin-bottom:20px; color:#ccc;">–û—Ñ–æ—Ä–º—ñ—Ç—å PRO, —â–æ–± –¥–∏–≤–∏—Ç–∏—Å—å —É—Å—ñ —Ñ—ñ–ª—å–º–∏ –±–µ–∑ –æ–±–º–µ–∂–µ–Ω—å.</p>
     <p style="margin-bottom:16px; color:#888; font-size:13px;">
    üí∏ –ë—É–¥—å-—è–∫–∞ —Å—É–º–∞ ‚Äî —Ü–µ –≤–∂–µ PRO  
    <br>üòâ –ê–ª–µ —á–∏–º –±—ñ–ª—å—à–µ ‚Äî —Ç–∏–º –∫—Ä–∞—â–µ!
   </p>
    <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
      <button onclick="goToPro()" style="padding:8px 16px; background:#00f7ff; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">üöÄ –ü–µ—Ä–µ–π—Ç–∏ –¥–æ PRO</button>
      <button onclick="closeProModal()" style="padding:8px 16px; background:#444; border:none; border-radius:8px; cursor:pointer; color:#fff;">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>
  </div>
</div>


<script>
 
</script>
<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ -->
<div id="suggest-modal" style="
  display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.85); z-index:9999; justify-content:center; align-items:center;
  opacity: 0; transition: opacity 0.3s ease;
">
  <div style="background:#222; padding:22px 20px; border-radius:12px; max-width:310px; text-align:center; box-shadow:0 0 15px #0ff;">
    <div id="suggest-modal-content" style="color:#fff; font-size:16px; line-height:1.5;"></div>
    <div style="margin-top:20px;">
      <button onclick="closeSuggestModal()" style="padding:8px 16px; background:#00f7ff; color:#000; font-weight:bold; border:none; border-radius:8px; cursor:pointer;">–û–ö</button>
    </div>
  </div>
</div>


<script>
function showSuggestResult({ success, remaining_requests, is_pro }) {
  const modal = document.getElementById('suggest-modal');
  const content = document.getElementById('suggest-modal-content');

  if (success) {
    content.innerHTML = `
      ‚úÖ –ó–∞–ø–∏—Ç –Ω–∞ —Ñ—ñ–ª—å–º –ø—Ä–∏–π–Ω—è—Ç–æ!<br><br>
      üÜì –ó–∞–ª–∏—à–∏–ª–æ—Å—å: <b>${remaining_requests}</b> –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤.
    `;
  } else if (is_pro) {
    content.innerHTML = `
      ‚ö†Ô∏è –©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ, –∞–ª–µ —É –≤–∞—Å —î PRO üòé<br><br>
      –ü–æ–≤—Ç–æ—Ä—ñ—Ç—å —Å–ø—Ä–æ–±—É —Ç—Ä–æ—Ö–∏ –ø—ñ–∑–Ω—ñ—à–µ.
    `;
  } else {
    content.innerHTML = `
      ‚õî –í–∏ –≤–∏—á–µ—Ä–ø–∞–ª–∏ –ª—ñ–º—ñ—Ç –∑–∞–ø–∏—Ç—ñ–≤.<br><br>
      üîì <b>–û—Ç—Ä–∏–º–∞–π—Ç–µ PRO</b> —ñ –∑–∞–º–æ–≤–ª—è–π—Ç–µ —Ñ—ñ–ª—å–º–∏ –±–µ–∑ –æ–±–º–µ–∂–µ–Ω—å!
    `;
  }

  modal.style.display = 'flex';
  setTimeout(() => modal.style.opacity = '1', 10);
}



  function closeSuggestModal() {
    const modal = document.getElementById('suggest-modal');
    modal.style.opacity = '0';
    setTimeout(() => modal.style.display = 'none', 300);
  }


async function requestFilm(filmName) {
  const telegramUser = window.Telegram.WebApp.initDataUnsafe?.user;
  if (!telegramUser) {
    alert("‚õî –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ Telegram");
    return;
  }

  const userId = telegramUser.id;

  try {
    const res = await fetch("https://relax-time2.onrender.com/send-film-id", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: userId, film_name: filmName })
    });

    const data = await res.json();

    // ‚úÖ –Ø–∫—â–æ —É—Å–ø—ñ—à–Ω–æ —ñ —î –ø–æ—Å–∏–ª–∞–Ω–Ω—è ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è
    if (data.success && data.url) {
      const container = document.createElement("div");
      container.style.textAlign = "center";
      container.style.padding = "40px 20px";
      container.style.color = "#fff";
      container.style.fontFamily = "'Russo One', sans-serif";
      container.innerHTML = `
        <div style="font-size:22px; margin-bottom:15px;">‚úÖ –í—ñ–¥–µ–æ –≥–æ—Ç–æ–≤–µ!</div>
        <a href="${data.url}" 
           target="_blank" 
           style="
             display:inline-block;
             padding:12px 24px;
             background:linear-gradient(90deg,#00f0ff,#0088ff);
             border-radius:12px;
             color:#fff;
             text-decoration:none;
             font-size:18px;
             font-weight:bold;
             box-shadow:0 0 15px #00aaff;
             transition:all 0.2s ease;
           "
           onmouseover="this.style.boxShadow='0 0 25px #00ffff';"
           onmouseout="this.style.boxShadow='0 0 15px #00aaff';"
        >üé¨ –í—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ—ñ–ª—å–º —É Telegram</a>
      `;

      document.body.innerHTML = "";
      document.body.appendChild(container);

      // üîí –ó–∞–∫—Ä–∏–≤–∞—î WebApp —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥–∏ –ø—ñ—Å–ª—è –ø–æ–∫–∞–∑—É (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
      setTimeout(() => {
        if (window.Telegram?.WebApp?.close) {
          window.Telegram.WebApp.close();
        }
      }, 4000);
    } else {
      alert(data.error || "‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ –≤—ñ–¥–µ–æ");
    }

  } catch (error) {
    console.error("‚ùó –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É:", error);
    showSuggestResult({
      success: false,
      remaining_requests: 0,
      is_pro: false
    });
  }
}


function showServiceErrorModal(msg, onRetry = null) {
  const modal   = document.getElementById('service-error-modal');
  const msgBox  = document.getElementById('service-error-message');
  const retryBtn= document.getElementById('service-retry-btn');

  if (msgBox) msgBox.innerHTML = msg || '–°–µ—Ä–≤—ñ—Å —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π,<br>—Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Ö–≤–∏–ª–∏–Ω—É.';
  serviceErrorRetry = (typeof onRetry === 'function') ? onRetry : null;

  // –ø–æ–∫–∞–∑—É—î–º–æ/—Ö–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫—É "–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑" –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∫–æ–ª–±–µ–∫—É
  if (retryBtn) retryBtn.style.display = serviceErrorRetry ? 'inline-block' : 'none';

  modal.style.display = 'flex';
  setTimeout(() => modal.style.opacity = '1', 10);
}

function closeServiceErrorModal() {
  const modal = document.getElementById('service-error-modal');
  modal.style.opacity = '0';
  setTimeout(() => modal.style.display = 'none', 300);
}


</script>




<!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø–æ–º–∏–ª–∫–∏ —Å–µ—Ä–≤—ñ—Å—É -->
<div id="service-error-modal" style="
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.85);
  z-index: 99999;
  justify-content: center;
  align-items: center;
  opacity: 0;
  transition: opacity 0.3s;
">
  <div style="
    background: #1a1a1a;
    padding: 28px 22px;
    border-radius: 14px;
    max-width: 320px;
    text-align: center;
    box-shadow: 0 0 24px #00f7ff;
  ">
    <div style="font-size:32px; margin-bottom:15px;">üò¢</div>
    <div id="service-error-message" style="color:#00f7ff; font-size:17px; margin-bottom:22px;">
      –°–µ—Ä–≤—ñ—Å —Ç–∏–º—á–∞—Å–æ–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π,<br>—Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ —Ö–≤–∏–ª–∏–Ω—É.
    </div>

    <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
      <button id="service-retry-btn" style="
        padding: 8px 14px; background: #00f7ff; color: #000;
        border: none; border-radius: 8px; font-weight: bold; cursor: pointer;
        font-size: 15px;
      ">üîÑ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑</button>

      <button id="service-reload-btn" style="
        padding: 8px 14px; background: #444; color: #fff;
        border: none; border-radius: 8px; cursor: pointer; font-size: 15px;
      ">‚ü≤ –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>

      <button id="service-ok-btn" style="
        padding: 8px 14px; background: #2b2b2b; color: #ddd;
        border: 1px solid #555; border-radius: 8px; cursor: pointer; font-size: 15px;
      ">OK</button>
    </div>
  </div>
</div>
<script>
  document.getElementById('service-retry-btn').addEventListener('click', () => {
    closeServiceErrorModal();
    try { serviceErrorRetry && serviceErrorRetry(); } catch (e) { console.warn(e); }
  });

  document.getElementById('service-reload-btn').addEventListener('click', () => {
    location.reload();
  });

  document.getElementById('service-ok-btn').addEventListener('click', () => {
    closeServiceErrorModal();
  });
</script>

<script>
  // –í—ñ–¥–∫—Ä–∏—Ç–∏ —á–∞—Ç –∑ –ª–∞—É–Ω—á–µ—Ä-–±–æ—Ç–æ–º —ñ–∑ payload'–æ–º (—Ö—Ç–æ –Ω–∞—Ç–∏—Å–Ω—É–≤)
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('launcher-btn');
    if (!btn) return;

    btn.addEventListener('click', () => {
      const tg  = window.Telegram?.WebApp;
      const uid = tg?.initDataUnsafe?.user?.id || '';
      const url = `https://t.me/relax_time_launcher_bot?start=from_webapp_${uid}`;

      try {
        if (tg?.openTelegramLink) tg.openTelegramLink(url);
        else if (tg?.openLink)    tg.openLink(url);
        else                      window.open(url, '_blank');
        tg?.HapticFeedback?.impactOccurred('medium');
      } catch (_) {
        window.open(url, '_blank');
      }
    });
  });
</script>


<!-- –ü–æ—Ä–æ–∂–Ω—ñ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ñ—Å—Ç–æ—Ä—ñ—ó, —â–æ–± –Ω–µ –ª–∞–º–∞–≤—Å—è .innerHTML=... -->
<div id="history-list" style="display:none;"></div>


<!-- –û–≤–µ—Ä–ª–µ–π "–ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏" -->
<div id="error-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:10000;align-items:center;justify-content:center;">
  <div style="background:#222;color:#fff;padding:20px;border-radius:12px;text-align:center;max-width:320px;">
    <p style="margin-bottom:14px;">–í—Ç—Ä–∞—á–µ–Ω–æ –∑‚Äô—î–¥–Ω–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏?</p>
    <button id="reload-btn" style="padding:8px 16px;background:#00f7ff;color:#000;border:none;border-radius:8px;font-weight:bold;cursor:pointer;">–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
  </div>
</div>
<script>
  // ‚úÖ –û—Ç—Ä–∏–º—É—î–º–æ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ Telegram WebApp
 
  const userId = tg.initDataUnsafe?.user?.id || null;
  const username = tg.initDataUnsafe?.user?.username || "";
  const firstName = tg.initDataUnsafe?.user?.first_name || "";

  // ‚úÖ –ö–Ω–æ–ø–∫–∞ "–û—Ç—Ä–∏–º–∞—Ç–∏ PRO"
  async function getPro() {
    try {
      const resp = await fetch("https://relax-time2.onrender.com/create-payment", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          user_id: userId,
          username: username,
          first_name: firstName,
          plan: "pro30"
        })
      });
      const data = await resp.json();
      if (data.ok) {
        localStorage.setItem("invoice_id", data.invoice_id);
        localStorage.setItem("paymentPending", "true");
        alert("‚úîÔ∏è –ó–∞–ø–∏—Ç –Ω–∞ PRO —Å—Ç–≤–æ—Ä–µ–Ω–æ! –ó–∞—Ä–∞–∑ –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è Monobank. –ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –Ω–∞—Ç–∏—Å–Ω–∏ '–Ø –æ–ø–ª–∞—Ç–∏–≤'.");
        tg.openLink("https://send.monobank.ua/jar/8FbfB4fY6S");  // ‚úÖ –≤—ñ–¥–∫—Ä–∏–≤–∞—î –±–∞–Ω–∫—É
        document.getElementById("confirmPaidBtn").style.display = "block";
      } else {
        alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –æ–ø–ª–∞—Ç–∏");
      }
    } catch (err) {
      console.error("–ü–æ–º–∏–ª–∫–∞ /create-payment:", err);
    }
  }

  // ‚úÖ –ö–Ω–æ–ø–∫–∞ "–Ø –æ–ø–ª–∞—Ç–∏–≤"
  async function notifyPaid() {
    const invoiceId = localStorage.getItem("invoice_id");
    if (!invoiceId) {
      alert("‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É –Ω–∞—Ç–∏—Å–Ω–∏ '–û—Ç—Ä–∏–º–∞—Ç–∏ PRO'");
      return;
    }
    try {
      await fetch("https://relax-time2.onrender.com/notify-payment", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
          user_id: userId,
          invoice_id: invoiceId
        })
      });
      alert("‚úÖ –ó–∞–ø–∏—Ç –Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ!");
    } catch (err) {
      console.error("–ü–æ–º–∏–ª–∫–∞ /notify-payment:", err);
    }
  }

  // üîó –ü—Ä–∏–≤'—è–∑—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById('getProBtn')?.addEventListener('click', getPro);
    document.getElementById('confirmPaidBtn')?.addEventListener('click', notifyPaid);
  });
</script>
  <script>
// ‚úÖ –Ø–∫—â–æ —î –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞ ‚Äî –ø–æ–∫–∞–∑—É—î –∫–Ω–æ–ø–∫—É "–Ø –æ–ø–ª–∞—Ç–∏–≤" –Ω–∞–≤—ñ—Ç—å –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É
document.addEventListener("DOMContentLoaded", async () => {
  const tg = window.Telegram.WebApp;
  const user = tg.initDataUnsafe?.user;

  // 1. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ PRO —Å—Ç–∞—Ç—É—Å
  let isPro = false;
  try {
    const resp = await fetch("https://relaxbox.site/check-pro", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user_id: user?.id })
    });
    const data = await resp.json();
    isPro = !!data.isPro;
  } catch (e) {
    console.warn("–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ PRO:", e);
  }

  // 2. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞
  const invoiceId = localStorage.getItem("invoice_id");
  const confirmBtn = document.getElementById("confirmPaidBtn");

  if (isPro) {
    // –Ø–∫—â–æ PRO –∞–∫—Ç–∏–≤–Ω–∏–π ‚Äî —Ö–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫—É —Ç–∞ –æ—á–∏—â–∞—î–º–æ invoice_id
    localStorage.removeItem("invoice_id");
    if (confirmBtn) confirmBtn.style.display = "none";
  } else if (invoiceId) {
    // –Ø–∫—â–æ –æ–ø–ª–∞—Ç–∞ —â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É
    if (confirmBtn) confirmBtn.style.display = "block";
  } else {
    // –Ø–∫—â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ–º–∞—î ‚Äî —Ö–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫—É
    if (confirmBtn) confirmBtn.style.display = "none";
  }
});
</script>
<script>
function openFilm(filmId) {
  if (!filmId) {
    alert("‚ùå ID —Ñ—ñ–ª—å–º—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");
    return;
  }

  // –û—Ç—Ä–∏–º—É—î–º–æ user_id —ñ–∑ Telegram WebApp
  const tg = window.Telegram?.WebApp;
  const userId = tg?.initDataUnsafe?.user?.id || 0;

  // URL –±–µ–∫–µ–Ω–¥—É (–∑–∞–º—ñ–Ω–∏ –¥–æ–º–µ–Ω –Ω–∞ —Å–≤—ñ–π —è–∫—â–æ —ñ–Ω—à–∏–π)
  const backend = "https://relax-time2.onrender.com";
  const url = `${backend}/watch/${filmId}?user_id=${userId}`;

  console.log("üé¨ –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ:", url);
  window.location.href = url;
}

<!-- ‚úÖ –î–æ–¥–∞—î–º–æ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—ñ–≤ -->
<script>
async function smartPlay(film) {
  try {
    const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
    const userId = tgUser.id || 0;

    // –Ø–∫—â–æ film –ø–µ—Ä–µ–¥–∞–Ω–æ –Ω–µ –æ–±‚Äô—î–∫—Ç–æ–º ‚Äî –ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–∞–Ω—ñ
    const msgId = film?.message_id || film?.id || film;
    const chId = film?.channel_id || film?.channel || "";

    const response = await fetch("https://relax-time2.onrender.com/send-film-id", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: userId,
        message_id: msgId,
        channel_id: chId
      })
    });

    const data = await response.json();
    console.log("üé¨ –í—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ /send-film-id:", data);

    if (data.success && data.url) {
      window.open(data.url, "_blank"); // –≤—ñ–¥–∫—Ä–∏–≤–∞—î —Ñ—ñ–ª—å–º —É Telegram
    } else {
      alert("‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–∫—Ä–∏—Ç–∏ —Ñ—ñ–ª—å–º.\n" + (data.error || "–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞"));
    }
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ smartPlay:", err);
    alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Ñ—ñ–ª—å–º—É üòî");
  }
}
</script>

</script>

</div>


</body>
</html>
